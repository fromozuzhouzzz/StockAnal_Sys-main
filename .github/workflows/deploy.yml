# GitHub Actions è‡ªåŠ¨éƒ¨ç½²åˆ° Hugging Face Spaces
# å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²

name: Deploy to Hugging Face Spaces

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]  # æ¨é€åˆ° main æˆ– master åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]  # PR åˆ° main æˆ– master åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  HF_HUB_ENABLE_HF_TRANSFER: 1  # å¯ç”¨ Hugging Face ä¼ è¾“ä¼˜åŒ–

jobs:
  deploy:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒ
    
    steps:
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²
        lfs: true       # æ”¯æŒ Git LFSï¼ˆå¦‚æœæœ‰å¤§æ–‡ä»¶ï¼‰

    # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # ä½¿ç”¨ Python 3.11
        cache: 'pip'            # ç¼“å­˜ pip ä¾èµ–

    # æ­¥éª¤ 3: å®‰è£…ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
        # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆç”¨äºéªŒè¯ï¼‰
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    # æ­¥éª¤ 4: éªŒè¯å¿…éœ€æ–‡ä»¶
    - name: éªŒè¯éƒ¨ç½²æ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥å¿…éœ€æ–‡ä»¶..."
        
        # æ£€æŸ¥å…¥å£æ–‡ä»¶
        if [ ! -f "app.py" ]; then
          echo "âŒ é”™è¯¯: app.py æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… app.py æ–‡ä»¶å­˜åœ¨"
        
        # æ£€æŸ¥ä¾èµ–æ–‡ä»¶
        if [ ! -f "requirements.txt" ]; then
          echo "âŒ é”™è¯¯: requirements.txt æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… requirements.txt æ–‡ä»¶å­˜åœ¨"
        
        # æ£€æŸ¥ README æ–‡ä»¶
        if [ -f "README_HF.md" ]; then
          echo "âœ… README_HF.md æ–‡ä»¶å­˜åœ¨"
        elif [ -f "README.md" ]; then
          echo "âœ… README.md æ–‡ä»¶å­˜åœ¨"
        else
          echo "âš ï¸ è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ° README æ–‡ä»¶"
        fi
        
        echo "ğŸ“‹ æ–‡ä»¶éªŒè¯å®Œæˆ"

    # æ­¥éª¤ 5: åˆ›å»º Hugging Face Spaces é…ç½®
    - name: åˆ›å»º Spaces é…ç½®
      run: |
        echo "ğŸ“ åˆ›å»º Hugging Face Spaces é…ç½®æ–‡ä»¶..."
        
        # åˆ›å»ºæˆ–æ›´æ–° README.mdï¼ˆHugging Face Spaces çš„é…ç½®æ–‡ä»¶ï¼‰
        if [ -f "README_HF.md" ]; then
          cp README_HF.md README.md
          echo "âœ… ä½¿ç”¨ README_HF.md ä½œä¸º Spaces é…ç½®"
        else
          # å¦‚æœæ²¡æœ‰ä¸“é—¨çš„ HF READMEï¼Œåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„
          printf '%s\n' \
            '---' \
            'title: æ™ºèƒ½åˆ†æç³»ç»Ÿï¼ˆè‚¡ç¥¨ï¼‰' \
            'emoji: ğŸ“ˆ' \
            'colorFrom: blue' \
            'colorTo: green' \
            'sdk: gradio' \
            'sdk_version: 4.44.0' \
            'app_file: app.py' \
            'pinned: false' \
            'license: mit' \
            '---' \
            '' \
            '# æ™ºèƒ½åˆ†æç³»ç»Ÿï¼ˆè‚¡ç¥¨ï¼‰' \
            '' \
            'è¿™æ˜¯ä¸€ä¸ªåŸºäºPythonå’ŒFlaskçš„æ™ºèƒ½è‚¡ç¥¨åˆ†æç³»ç»Ÿï¼Œç°å·²éƒ¨ç½²åˆ°Hugging Face Spaceså¹³å°ã€‚' \
            '' \
            '## åŠŸèƒ½ç‰¹ç‚¹' \
            '' \
            '- å¤šç»´åº¦è‚¡ç¥¨åˆ†æï¼šæŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€èµ„é‡‘é¢ç»¼åˆåˆ†æ' \
            '- AIå¢å¼ºåˆ†æï¼šé›†æˆAI APIæä¾›ä¸“ä¸šæŠ•èµ„å»ºè®®' \
            '- å®æ—¶æ•°æ®ï¼šè·å–æœ€æ–°è‚¡ç¥¨æ•°æ®å’Œè´¢ç»æ–°é—»' \
            '- å¯è§†åŒ–å›¾è¡¨ï¼šäº¤äº’å¼Kçº¿å›¾å’ŒæŠ€æœ¯æŒ‡æ ‡' \
            '- æ™ºèƒ½è¯„åˆ†ï¼š100åˆ†åˆ¶ç»¼åˆè¯„åˆ†ç³»ç»Ÿ' \
            '' \
            '## å…è´£å£°æ˜' \
            '' \
            'æœ¬ç³»ç»Ÿä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼ŒAIç”Ÿæˆçš„å†…å®¹å¯èƒ½å­˜åœ¨é”™è¯¯ï¼Œè¯·å‹¿ä½œä¸ºæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚' \
            > README.md
          echo "âœ… åˆ›å»ºäº†åŸºæœ¬çš„ Spaces é…ç½®æ–‡ä»¶"
        fi

    # æ­¥éª¤ 6: è®¾ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶
    - name: è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
        
        # åˆ›å»º .env æ–‡ä»¶ç”¨äº Hugging Face Spaces
        printf '%s\n' \
          '# Hugging Face Spaces ç¯å¢ƒå˜é‡é…ç½®' \
          'API_PROVIDER=openai' \
          'USE_DATABASE=False' \
          'USE_REDIS_CACHE=False' \
          'PORT=7860' \
          'FLASK_ENV=production' \
          'PYTHONUNBUFFERED=1' \
          'PYTHONDONTWRITEBYTECODE=1' \
          > .env
        
        echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"

    # æ­¥éª¤ 7: éƒ¨ç½²åˆ° Hugging Face Spaces
    - name: éƒ¨ç½²åˆ° Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_SPACE: ${{ secrets.HF_SPACE }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Hugging Face Spaces..."
        
        # éªŒè¯å¿…éœ€çš„ secrets
        if [ -z "$HF_TOKEN" ]; then
          echo "âŒ é”™è¯¯: HF_TOKEN secret æœªè®¾ç½®"
          exit 1
        fi
        
        if [ -z "$HF_SPACE" ]; then
          echo "âŒ é”™è¯¯: HF_SPACE secret æœªè®¾ç½®"
          exit 1
        fi
        
        echo "âœ… Secrets éªŒè¯é€šè¿‡"
        echo "ğŸ“ ç›®æ ‡ Space: $HF_SPACE"
        
        # ä½¿ç”¨ huggingface_hub è¿›è¡Œéƒ¨ç½²
        python -c '
        import os
        from huggingface_hub import HfApi, upload_folder
        import sys

        try:
            # åˆå§‹åŒ– HF API
            api = HfApi(token=os.environ["HF_TOKEN"])

            # è·å– Space ä¿¡æ¯
            space_id = os.environ["HF_SPACE"]
            print(f"ğŸ” æ£€æŸ¥ Space: {space_id}")

            # æ£€æŸ¥ Space æ˜¯å¦å­˜åœ¨
            try:
                space_info = api.space_info(space_id)
                print(f"âœ… Space å­˜åœ¨: {space_info.id}")
            except Exception as e:
                print(f"âŒ Space ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: {e}")
                sys.exit(1)

            # ä¸Šä¼ æ–‡ä»¶åˆ° Space
            print("ğŸ“¤ å¼€å§‹ä¸Šä¼ æ–‡ä»¶...")

            # å®šä¹‰è¦å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•
            ignore_patterns = [
                ".git*",
                "__pycache__",
                "*.pyc",
                ".env.example",
                ".env-example",
                "logs/",
                "data/news/",
                ".pytest_cache",
                "tests/",
                "docs/",
                "images/",
                "*.log",
                "fly.toml",
                "render.yaml",
                "railway.json",
                "vercel.json",
                "Dockerfile",
                "docker-compose.yml",
                "start.sh",
                "éƒ¨ç½²æ£€æŸ¥æ¸…å•.md",
                "hf_deployment_check.py"
            ]

            # ä¸Šä¼ æ•´ä¸ªé¡¹ç›®åˆ° Space
            upload_folder(
                folder_path=".",
                repo_id=space_id,
                repo_type="space",
                token=os.environ["HF_TOKEN"],
                ignore_patterns=ignore_patterns,
                commit_message=f"Auto-deploy from GitHub Actions - {os.environ.get(\"GITHUB_SHA\", \"unknown\")[:7]}"
            )

            print("âœ… éƒ¨ç½²å®Œæˆ!")
            print(f"ğŸŒ è®¿é—®åœ°å€: https://huggingface.co/spaces/{space_id}")

        except Exception as e:
            print(f"âŒ éƒ¨ç½²å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        '

    # æ­¥éª¤ 8: éƒ¨ç½²åéªŒè¯
    - name: éƒ¨ç½²åéªŒè¯
      if: success()
      run: |
        echo "ğŸ” éƒ¨ç½²åéªŒè¯..."
        echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ!"
        echo "ğŸŒ æ‚¨çš„åº”ç”¨å°†åœ¨å‡ åˆ†é’Ÿå†…åœ¨ä»¥ä¸‹åœ°å€å¯ç”¨:"
        echo "   https://huggingface.co/spaces/${{ secrets.HF_SPACE }}"
        echo ""
        echo "ğŸ“‹ åç»­æ­¥éª¤:"
        echo "1. ç­‰å¾… 2-5 åˆ†é’Ÿè®© Hugging Face æ„å»ºæ‚¨çš„åº”ç”¨"
        echo "2. è®¿é—®ä¸Šè¿°é“¾æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€"
        echo "3. å¦‚æœéœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¯·åœ¨ Space è®¾ç½®ä¸­æ·»åŠ "
        echo ""
        echo "ğŸ”§ å¦‚éœ€è®¾ç½®ç¯å¢ƒå˜é‡:"
        echo "1. è®¿é—®æ‚¨çš„ Space é¡µé¢"
        echo "2. ç‚¹å‡» 'Settings' é€‰é¡¹å¡"
        echo "3. åœ¨ 'Variables and secrets' éƒ¨åˆ†æ·»åŠ å¿…è¦çš„ç¯å¢ƒå˜é‡"

    # æ­¥éª¤ 9: é”™è¯¯å¤„ç†
    - name: éƒ¨ç½²å¤±è´¥å¤„ç†
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥!"
        echo ""
        echo "ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥:"
        echo "1. æ£€æŸ¥ HF_TOKEN æ˜¯å¦æ­£ç¡®è®¾ç½®ä¸”æœ‰å†™å…¥æƒé™"
        echo "2. æ£€æŸ¥ HF_SPACE æ ¼å¼æ˜¯å¦æ­£ç¡® (ç”¨æˆ·å/spaceåç§°)"
        echo "3. ç¡®è®¤ Space å­˜åœ¨ä¸”æ‚¨æœ‰è®¿é—®æƒé™"
        echo "4. æ£€æŸ¥ app.py å’Œ requirements.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨"
        echo ""
        echo "ğŸ“‹ è·å–å¸®åŠ©:"
        echo "1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "2. æ£€æŸ¥ Hugging Face Space çš„æ„å»ºæ—¥å¿—"
        echo "3. å‚è€ƒé¡¹ç›®æ–‡æ¡£ä¸­çš„æ•…éšœæ’é™¤éƒ¨åˆ†"
