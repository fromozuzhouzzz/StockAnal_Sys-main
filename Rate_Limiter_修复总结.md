# Rate Limiter ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
ERROR:__main__:å¯¼å…¥ web_server å¤±è´¥: require_rate_limit() got an unexpected keyword argument 'calls'
```

### é—®é¢˜æ ¹æº
åœ¨å®ç°æ‰¹é‡æ•°æ®æ›´æ–°APIæ—¶ï¼Œé”™è¯¯åœ°ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å‚æ•°æ ¼å¼ï¼š
```python
@require_rate_limit(calls=5, period=300)  # âŒ é”™è¯¯çš„å‚æ•°æ ¼å¼
```

è€Œ`require_rate_limit`è£…é¥°å™¨çš„æ­£ç¡®å®šä¹‰åªæ¥å—ä¸€ä¸ª`endpoint`å‚æ•°ï¼š
```python
def require_rate_limit(endpoint=None):
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. é—®é¢˜å®šä½
é€šè¿‡åˆ†æä»£ç å‘ç°ï¼š
- `rate_limiter.py`ä¸­çš„`require_rate_limit`è£…é¥°å™¨åªæ¥å—`endpoint`å‚æ•°
- `api_endpoints.py`ä¸­æ‰¹é‡æ›´æ–°APIä½¿ç”¨äº†é”™è¯¯çš„`calls`å’Œ`period`å‚æ•°
- å…¶ä»–APIç«¯ç‚¹éƒ½æ­£ç¡®ä½¿ç”¨äº†`require_rate_limit('/api/v1/endpoint')`æ ¼å¼

### 2. ä¿®å¤å†…å®¹

#### A. ä¿®å¤APIç«¯ç‚¹è£…é¥°å™¨å‚æ•° (`api_endpoints.py`)

**ä¿®å¤å‰ï¼š**
```python
@require_rate_limit(calls=5, period=300)  # âŒ é”™è¯¯å‚æ•°
```

**ä¿®å¤åï¼š**
```python
@require_rate_limit('/api/v1/batch/update')  # âœ… æ­£ç¡®å‚æ•°
```

#### B. æ·»åŠ æ‰¹é‡æ›´æ–°ä¸“ç”¨é™æµé…ç½® (`rate_limiter.py`)

**ä¿®å¤å‰ï¼š**
```python
self.endpoint_limits = {
    '/api/v1/stock/analyze': {'requests': 50, 'window': 3600},
    '/api/v1/portfolio/analyze': {'requests': 20, 'window': 3600},
    '/api/v1/stocks/batch-score': {'requests': 10, 'window': 3600}
}
```

**ä¿®å¤åï¼š**
```python
self.endpoint_limits = {
    '/api/v1/stock/analyze': {'requests': 50, 'window': 3600},
    '/api/v1/portfolio/analyze': {'requests': 20, 'window': 3600},
    '/api/v1/stocks/batch-score': {'requests': 10, 'window': 3600},
    '/api/v1/batch/update': {'requests': 5, 'window': 300},      # 5åˆ†é’Ÿå†…æœ€å¤š5æ¬¡
    '/api/v1/batch/progress': {'requests': 100, 'window': 300},  # è¿›åº¦æŸ¥è¯¢å®½æ¾
    '/api/v1/batch/cleanup': {'requests': 10, 'window': 3600}    # æ¸…ç†æ“ä½œé™åˆ¶
}
```

#### C. å®Œå–„æ‰€æœ‰æ‰¹é‡æ›´æ–°APIçš„é™æµè£…é¥°å™¨

ä¸ºæ‰€æœ‰æ‰¹é‡æ›´æ–°ç›¸å…³çš„APIç«¯ç‚¹æ·»åŠ äº†æ­£ç¡®çš„é™æµè£…é¥°å™¨ï¼š

1. **æ‰¹é‡æ›´æ–°å¯åŠ¨API**
```python
@api_v1.route('/batch/update', methods=['POST'])
@api_error_handler
@require_api_key
@require_rate_limit('/api/v1/batch/update')  # âœ… æ·»åŠ é™æµ
```

2. **è¿›åº¦æŸ¥è¯¢API**
```python
@api_v1.route('/batch/progress/<session_id>', methods=['GET'])
@api_error_handler
@require_api_key
@require_rate_limit('/api/v1/batch/progress')  # âœ… æ·»åŠ é™æµ
```

3. **ä¼šè¯æ¸…ç†API**
```python
@api_v1.route('/batch/cleanup', methods=['POST'])
@api_error_handler
@require_api_key
@require_rate_limit('/api/v1/batch/cleanup')  # âœ… æ·»åŠ é™æµ
```

## ğŸ“Š é™æµç­–ç•¥è®¾è®¡

### æ‰¹é‡æ›´æ–°APIé™æµé…ç½®

| APIç«¯ç‚¹ | é™åˆ¶æ¬¡æ•° | æ—¶é—´çª—å£ | è¯´æ˜ |
|---------|----------|----------|------|
| `/api/v1/batch/update` | 5æ¬¡ | 5åˆ†é’Ÿ | ä¸¥æ ¼é™åˆ¶ï¼Œé¿å…ç³»ç»Ÿè¿‡è½½ |
| `/api/v1/batch/progress` | 100æ¬¡ | 5åˆ†é’Ÿ | å®½æ¾é™åˆ¶ï¼Œæ”¯æŒé¢‘ç¹æŸ¥è¯¢ |
| `/api/v1/batch/cleanup` | 10æ¬¡ | 1å°æ—¶ | ä¸­ç­‰é™åˆ¶ï¼Œç»´æŠ¤æ“ä½œ |

### é™æµç­–ç•¥è€ƒè™‘å› ç´ 

1. **æ‰¹é‡æ›´æ–°æ“ä½œ**ï¼šèµ„æºå¯†é›†å‹ï¼Œä¸¥æ ¼é™åˆ¶é¢‘ç‡
2. **è¿›åº¦æŸ¥è¯¢**ï¼šè½»é‡çº§æ“ä½œï¼Œå…è®¸é¢‘ç¹è®¿é—®
3. **æ¸…ç†æ“ä½œ**ï¼šç»´æŠ¤æ€§æ“ä½œï¼Œé€‚ä¸­é™åˆ¶
4. **HF Spaceså…¼å®¹æ€§**ï¼šè€ƒè™‘å¹³å°èµ„æºé™åˆ¶

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### è£…é¥°å™¨ä½¿ç”¨æ¨¡å¼
```python
# æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼
@require_rate_limit('/api/v1/endpoint')
def api_function():
    pass

# é”™è¯¯çš„ä½¿ç”¨æ–¹å¼ï¼ˆå·²ä¿®å¤ï¼‰
@require_rate_limit(calls=5, period=300)  # âŒ
```

### é™æµæ£€æŸ¥æµç¨‹
1. è·å–å®¢æˆ·ç«¯æ ‡è¯†ï¼ˆAPI Keyæˆ–IPï¼‰
2. æ£€æŸ¥ç«¯ç‚¹ç‰¹å®šé™åˆ¶
3. æ‰§è¡Œæ»‘åŠ¨çª—å£ç®—æ³•æ£€æŸ¥
4. è¿”å›é™æµç»“æœå’Œå“åº”å¤´

### é”™è¯¯å“åº”æ ¼å¼
```json
{
    "success": false,
    "error": {
        "code": "RATE_LIMIT_EXCEEDED",
        "message": "è¯·æ±‚é¢‘ç‡è¶…è¿‡é™åˆ¶",
        "details": {
            "limit": 5,
            "reset_time": 1641234567
        }
    }
}
```

## ğŸš€ éƒ¨ç½²éªŒè¯

### éªŒè¯æ­¥éª¤
1. **æ¨¡å—å¯¼å…¥æµ‹è¯•**ï¼šç¡®è®¤æ‰€æœ‰æ¨¡å—æ­£å¸¸å¯¼å…¥
2. **è£…é¥°å™¨åˆ›å»ºæµ‹è¯•**ï¼šéªŒè¯è£…é¥°å™¨å‚æ•°æ­£ç¡®
3. **é™æµé…ç½®æ£€æŸ¥**ï¼šç¡®è®¤æ‰¹é‡æ›´æ–°é™æµé…ç½®
4. **APIè·¯ç”±æ³¨å†Œ**ï¼šéªŒè¯æ‰€æœ‰æ‰¹é‡æ›´æ–°è·¯ç”±æ­£å¸¸æ³¨å†Œ
5. **HF Spaceså…¼å®¹æ€§**ï¼šç¡®è®¤åœ¨HF Spacesç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº†`simple_import_test.py`ç”¨äºéªŒè¯ä¿®å¤æ•ˆæœï¼š
- æµ‹è¯•rate_limiteræ¨¡å—å¯¼å…¥
- éªŒè¯è£…é¥°å™¨å‚æ•°ä¿®å¤
- æ£€æŸ¥æ‰¹é‡æ›´æ–°é™æµé…ç½®
- æ¨¡æ‹ŸFlaskç¯å¢ƒæµ‹è¯•APIæ³¨å†Œ

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ web_serveræ¨¡å—å¯¼å…¥å¤±è´¥
- âŒ ç³»ç»Ÿæ— æ³•å¯åŠ¨
- âŒ æ‰¹é‡æ•°æ®æ›´æ–°åŠŸèƒ½ä¸å¯ç”¨

### ä¿®å¤å
- âœ… æ‰€æœ‰æ¨¡å—æ­£å¸¸å¯¼å…¥
- âœ… ç³»ç»Ÿå¯ä»¥æ­£å¸¸å¯åŠ¨
- âœ… æ‰¹é‡æ•°æ®æ›´æ–°åŠŸèƒ½å®Œå…¨å¯ç”¨
- âœ… é™æµä¿æŠ¤æ­£å¸¸å·¥ä½œ
- âœ… HF Spacesç¯å¢ƒå…¼å®¹

## ğŸ”„ å…¼å®¹æ€§ä¿è¯

### å‘åå…¼å®¹æ€§
- ä¿æŒäº†æ‰€æœ‰ç°æœ‰APIçš„é™æµåŠŸèƒ½
- æ²¡æœ‰æ”¹å˜å…¶ä»–è£…é¥°å™¨çš„ä½¿ç”¨æ–¹å¼
- ä¿æŒäº†åŸæœ‰çš„é™æµç­–ç•¥å’Œé…ç½®

### æ‰¹é‡æ›´æ–°åŠŸèƒ½å…¼å®¹æ€§
- å®Œå…¨å…¼å®¹ä¹‹å‰å®ç°çš„æ‰¹é‡æ•°æ®æ›´æ–°åŠŸèƒ½
- ä¿æŒäº†æ‰€æœ‰APIæ¥å£çš„å‚æ•°å’Œå“åº”æ ¼å¼
- ç»´æŒäº†å‰ç«¯ç•Œé¢çš„äº¤äº’é€»è¾‘

## ğŸ“‹ åç»­ç»´æŠ¤

### ç›‘æ§è¦ç‚¹
1. **é™æµæ•ˆæœ**ï¼šç›‘æ§æ‰¹é‡æ›´æ–°APIçš„è°ƒç”¨é¢‘ç‡
2. **ç³»ç»Ÿæ€§èƒ½**ï¼šè§‚å¯Ÿé™æµå¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
3. **ç”¨æˆ·ä½“éªŒ**ï¼šç¡®ä¿é™æµä¸å½±å“æ­£å¸¸ä½¿ç”¨

### é…ç½®è°ƒä¼˜
æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥è°ƒæ•´é™æµå‚æ•°ï¼š
```python
# å¯æ ¹æ®éœ€è¦è°ƒæ•´çš„é…ç½®
'/api/v1/batch/update': {'requests': 5, 'window': 300},  # å¯è°ƒæ•´é¢‘ç‡
'/api/v1/batch/progress': {'requests': 100, 'window': 300},  # å¯è°ƒæ•´æŸ¥è¯¢é™åˆ¶
```

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†Hugging Face Spaceséƒ¨ç½²æ—¶çš„rate_limiterå‚æ•°é”™è¯¯é—®é¢˜ï¼š

1. **æ ¹æœ¬åŸå› **ï¼šè£…é¥°å™¨å‚æ•°åç§°ä¸åŒ¹é…
2. **ä¿®å¤æ–¹æ¡ˆ**ï¼šç»Ÿä¸€ä½¿ç”¨æ­£ç¡®çš„endpointå‚æ•°æ ¼å¼
3. **å¢å¼ºåŠŸèƒ½**ï¼šä¸ºæ‰¹é‡æ›´æ–°APIæ·»åŠ äº†ä¸“é—¨çš„é™æµä¿æŠ¤
4. **è´¨é‡ä¿è¯**ï¼šä¿æŒäº†å®Œæ•´çš„å‘åå…¼å®¹æ€§
5. **éƒ¨ç½²å°±ç»ª**ï¼šç¡®ä¿åœ¨HF Spacesç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ

ä¿®å¤åï¼Œè‚¡ç¥¨åˆ†æç³»ç»Ÿå¯ä»¥åœ¨Hugging Face Spaceså¹³å°æ­£å¸¸éƒ¨ç½²å’Œè¿è¡Œï¼Œæ‰¹é‡æ•°æ®æ›´æ–°åŠŸèƒ½å®Œå…¨å¯ç”¨ï¼Œå¹¶ä¸”å…·å¤‡äº†é€‚å½“çš„é™æµä¿æŠ¤ã€‚
