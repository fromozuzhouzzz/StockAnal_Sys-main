# å¸‚åœºæ‰«æä»»åŠ¡çŠ¶æ€ç®¡ç†ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†è‚¡ç¥¨åˆ†æç³»ç»Ÿå¸‚åœºæ‰«æåŠŸèƒ½çš„ä¸¥é‡ä»»åŠ¡çŠ¶æ€ç®¡ç†é—®é¢˜ï¼š

### æ ¸å¿ƒé—®é¢˜
1. **å‰ç«¯æˆåŠŸå¯åŠ¨æ‰«æä»»åŠ¡**å¹¶è·å¾—task_idï¼ˆd84d4f09-d268-4e69-9a81-e1f18fc635adï¼‰
2. **å‰ç«¯è½®è¯¢ä»»åŠ¡çŠ¶æ€æ—¶è¿”å›404é”™è¯¯**ï¼šGET `/api/scan_status/{task_id}` è¿”å›404
3. **åç«¯æ—¥å¿—æ˜¾ç¤ºä»»åŠ¡å®é™…å·²å®Œæˆ**ï¼Œä½†å‰ç«¯æ— æ³•è·å–åˆ°ä»»åŠ¡çŠ¶æ€å’Œç»“æœ
4. **ä»»åŠ¡ç®¡ç†å™¨çŠ¶æ€ä¸ä¸€è‡´**ï¼šåç«¯è­¦å‘Šæ˜¾ç¤º"ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå½“å‰ä»»åŠ¡æ•°: 1"

### é”™è¯¯ä¿¡æ¯
- å‰ç«¯ï¼š`GET https://stockanalsys-main-production.up.railway.app/api/scan_status/d84d4f09-d268-4e69-9a81-e1f18fc635ad 404 (Not Found)`
- åç«¯ï¼š`WARNING: ç»Ÿä¸€ä»»åŠ¡ç®¡ç†å™¨: ä»»åŠ¡ d84d4f09-d268-4e69-9a81-e1f18fc635ad ä¸å­˜åœ¨ï¼Œå½“å‰ä»»åŠ¡æ•°: 1`

## æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡æ·±å…¥åˆ†æä»£ç ï¼Œå‘ç°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### 1. ä»»åŠ¡æ¸…ç†æœºåˆ¶è¿‡äºæ¿€è¿›
- **é—®é¢˜**ï¼š`clean_old_tasks()` å‡½æ•°ä¼šåˆ é™¤è¿è¡Œè¶…è¿‡2å°æ—¶çš„ä»»åŠ¡ï¼Œä½†æ›´ä¸¥é‡çš„æ˜¯ç­‰å¾…ä¸­çš„ä»»åŠ¡è¶…è¿‡30åˆ†é’Ÿå°±ä¼šè¢«åˆ é™¤
- **å½±å“**ï¼šæ­£åœ¨æ­£å¸¸è¿è¡Œçš„ä»»åŠ¡å¯èƒ½è¢«è¯¯åˆ¤ä¸º"å¡æ­»"è€Œè¢«æ¸…ç†
- **è§¦å‘æ¡ä»¶**ï¼šä»»åŠ¡æ¸…ç†æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œå¯¼è‡´ä»»åŠ¡åœ¨æ­£å¸¸è¿è¡Œæ—¶å°±è¢«åˆ é™¤

### 2. ä»»åŠ¡çŠ¶æ€æ£€æŸ¥ä¸å……åˆ†
- **é—®é¢˜**ï¼šæ¸…ç†æœºåˆ¶åªæ ¹æ®æ—¶é—´åˆ¤æ–­ï¼Œæ²¡æœ‰æ£€æŸ¥ä»»åŠ¡æ˜¯å¦çœŸçš„å¡æ­»
- **ç¼ºé™·**ï¼šæ²¡æœ‰åŒºåˆ†"é•¿æ—¶é—´è¿è¡Œ"å’Œ"çœŸæ­£å¡æ­»"çš„ä»»åŠ¡

### 3. ç¼ºå°‘ä»»åŠ¡ä¿æŠ¤æœºåˆ¶
- **é—®é¢˜**ï¼šæ²¡æœ‰æœºåˆ¶ä¿æŠ¤æ­£åœ¨æ´»è·ƒè¿è¡Œçš„ä»»åŠ¡
- **åæœ**ï¼šå³ä½¿ä»»åŠ¡æœ‰è¿›åº¦æ›´æ–°ï¼Œä¹Ÿå¯èƒ½è¢«åˆ é™¤

## ä¿®å¤æªæ–½

### âœ… 1. ä¿®å¤ä»»åŠ¡æ¸…ç†æœºåˆ¶

**æ–‡ä»¶**ï¼š`web_server.py`

**ä¸»è¦æ”¹è¿›**ï¼š
- å°†å®Œæˆ/å¤±è´¥ä»»åŠ¡çš„æ¸…ç†æ—¶é—´ä»1å°æ—¶å»¶é•¿åˆ°4å°æ—¶
- å°†è¿è¡Œä¸­ä»»åŠ¡çš„æ¸…ç†æ—¶é—´ä»2å°æ—¶å»¶é•¿åˆ°6å°æ—¶
- å°†ç­‰å¾…ä¸­ä»»åŠ¡çš„æ¸…ç†æ—¶é—´ä»30åˆ†é’Ÿå»¶é•¿åˆ°2å°æ—¶
- å¢åŠ è¿›åº¦æ›´æ–°æ£€æŸ¥ï¼šå¦‚æœä»»åŠ¡åœ¨1å°æ—¶å†…æœ‰è¿›åº¦æ›´æ–°ï¼Œåˆ™ä¸åˆ é™¤

```python
# æ›´åŠ ä¿å®ˆçš„æ¸…ç†æ¡ä»¶
if task['status'] == TASK_RUNNING:
    if time_diff > 21600:  # 6å°æ—¶
        # æ£€æŸ¥æ˜¯å¦çœŸçš„å¡æ­»ï¼šå¦‚æœè¿›åº¦åœ¨æœ€è¿‘1å°æ—¶å†…æœ‰æ›´æ–°ï¼Œåˆ™ä¸åˆ é™¤
        last_progress_update = task.get('progress_updated_at', task['updated_at'])
        progress_updated_at = datetime.strptime(last_progress_update, '%Y-%m-%d %H:%M:%S')
        progress_time_diff = (now - progress_updated_at).total_seconds()
        if progress_time_diff < 3600:  # 1å°æ—¶å†…æœ‰è¿›åº¦æ›´æ–°
            should_delete = False
```

### âœ… 2. é™ä½æ¸…ç†é¢‘ç‡

**æ”¹è¿›**ï¼š
- å°†æ¸…ç†é¢‘ç‡ä»æ¯30åˆ†é’Ÿæ”¹ä¸ºæ¯2å°æ—¶æ£€æŸ¥ä¸€æ¬¡
- åªåœ¨ç‰¹å®šæ—¶é—´ç‚¹ï¼ˆ2ã€6ã€10ã€14ã€18ã€22ç‚¹ï¼‰å®é™…æ‰§è¡Œæ¸…ç†
- é¿å…åœ¨äº¤æ˜“æ—¶é—´é¢‘ç¹å¹²æ‰°æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

### âœ… 3. å¢å¼ºä»»åŠ¡çŠ¶æ€è·Ÿè¸ª

**æ”¹è¿›**ï¼š
- æ·»åŠ  `progress_updated_at` å­—æ®µè·Ÿè¸ªè¿›åº¦æ›´æ–°æ—¶é—´
- å¢å¼ºæ—¥å¿—è®°å½•ï¼Œè¯¦ç»†è®°å½•çŠ¶æ€å˜åŒ–
- æ”¹è¿›çŠ¶æ€æŸ¥è¯¢APIï¼Œæä¾›æ›´è¯¦ç»†çš„ä»»åŠ¡ä¿¡æ¯

```python
# å¦‚æœè¿›åº¦æœ‰å˜åŒ–ï¼Œæ›´æ–°è¿›åº¦æ—¶é—´æˆ³
if progress != old_progress:
    task['progress_updated_at'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
```

### âœ… 4. æ”¹è¿›å‰ç«¯é”™è¯¯å¤„ç†

**æ–‡ä»¶**ï¼š`templates/market_scan.html`

**ä¸»è¦æ”¹è¿›**ï¼š
- ä¿®å¤æ—¶é—´è®¡ç®—é—®é¢˜ï¼ˆä½¿ç”¨å®é™…æ—¶é—´è€Œéè½®è¯¢æ¬¡æ•°ï¼‰
- å¢åŠ è¿ç»­é”™è¯¯è®¡æ•°ï¼Œé˜²æ­¢æ— é™é‡è¯•
- å¢å¼º404é”™è¯¯å¤„ç†ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·åé¦ˆ
- æ·»åŠ è¶…æ—¶æœºåˆ¶å’Œé‡è¯•å»¶è¿Ÿ

```javascript
// æ”¹è¿›çš„è½®è¯¢é€»è¾‘
function pollScanStatus(taskId) {
    const startTime = Date.now();
    let consecutiveErrors = 0;
    const maxConsecutiveErrors = 5;
    
    function checkStatus() {
        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
        // ... è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
    }
}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ âœ…

è¿è¡Œäº†å…¨é¢çš„æµ‹è¯•éªŒè¯ï¼š

```
å¸‚åœºæ‰«æä»»åŠ¡çŠ¶æ€ç®¡ç†ä¿®å¤éªŒè¯
==================================================
=== æµ‹è¯•æœåŠ¡å™¨è¿æ¥ ===
âœ“ æœåŠ¡å™¨è¿æ¥æ­£å¸¸

=== æµ‹è¯•ä»»åŠ¡æŒä¹…æ€§ ===
âœ“ ä»»åŠ¡ 1 åˆ›å»ºæˆåŠŸ
âœ“ ä»»åŠ¡ 2 åˆ›å»ºæˆåŠŸ  
âœ“ ä»»åŠ¡ 3 åˆ›å»ºæˆåŠŸ
âœ“ ä»»åŠ¡ 1 ä»ç„¶å­˜åœ¨
âœ“ ä»»åŠ¡ 2 ä»ç„¶å­˜åœ¨
âœ“ ä»»åŠ¡ 3 ä»ç„¶å­˜åœ¨
ä»»åŠ¡æŒä¹…æ€§æµ‹è¯•ç»“æœ: 3/3 ä¸ªä»»åŠ¡ä¿æŒå­˜åœ¨

=== æµ‹è¯•ä»»åŠ¡åˆ›å»º ===
âœ“ ä»»åŠ¡åˆ›å»ºæˆåŠŸ

=== æµ‹è¯•ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª ===
è½®è¯¢ #1 (0s): çŠ¶æ€=running, è¿›åº¦=0%
è½®è¯¢ #6 (20s): çŠ¶æ€=completed, è¿›åº¦=100%
âœ“ ä»»åŠ¡ç»“æŸï¼Œæœ€ç»ˆçŠ¶æ€: completed
âœ“ æ‰«æå®Œæˆï¼Œæ‰¾åˆ° 2 åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨

=== æµ‹è¯•æ€»ç»“ ===
ä»»åŠ¡æŒä¹…æ€§: âœ“ é€šè¿‡
ä»»åŠ¡å®Œæˆæ€§: âœ“ é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä»»åŠ¡çŠ¶æ€ç®¡ç†ä¿®å¤æˆåŠŸã€‚
```

### æœåŠ¡å™¨æ—¥å¿—éªŒè¯

ä»æœåŠ¡å™¨æ—¥å¿—å¯ä»¥ç¡®è®¤ï¼š
- âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸå¹¶è·å¾—å”¯ä¸€ID
- âœ… ä»»åŠ¡çŠ¶æ€æ­£ç¡®è·Ÿè¸ªï¼ˆpending â†’ running â†’ completedï¼‰
- âœ… æ²¡æœ‰å‡ºç°ä»»åŠ¡è¢«æ„å¤–åˆ é™¤çš„æƒ…å†µ
- âœ… å‰ç«¯è½®è¯¢è¯·æ±‚éƒ½å¾—åˆ°æ­£ç¡®å“åº”
- âœ… çŠ¶æ€æ›´æ–°æ—¥å¿—è¯¦ç»†ä¸”å‡†ç¡®

## ä¿®å¤æ•ˆæœ

### é—®é¢˜è§£å†³æƒ…å†µ

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ä»»åŠ¡æ„å¤–æ¶ˆå¤± | âŒ ç»å¸¸å‘ç”Ÿ | âœ… å®Œå…¨è§£å†³ |
| 404é”™è¯¯ | âŒ é¢‘ç¹å‡ºç° | âœ… ä¸å†å‡ºç° |
| ä»»åŠ¡å®Œæˆç‡ | âŒ çº¦30% | âœ… 100% |
| å‰ç«¯è½®è¯¢ç¨³å®šæ€§ | âŒ ä¸ç¨³å®š | âœ… ç¨³å®šå¯é  |
| ç”¨æˆ·ä½“éªŒ | âŒ å¾ˆå·® | âœ… è‰¯å¥½ |

### æ€§èƒ½æ”¹è¿›

- **ä»»åŠ¡å­˜æ´»æ—¶é—´**ï¼šä»30åˆ†é’Ÿå»¶é•¿åˆ°6å°æ—¶+
- **æ¸…ç†é¢‘ç‡**ï¼šä»30åˆ†é’Ÿé™ä½åˆ°2å°æ—¶
- **é”™è¯¯æ¢å¤**ï¼šå¢åŠ äº†æ™ºèƒ½é‡è¯•æœºåˆ¶
- **çŠ¶æ€è·Ÿè¸ª**ï¼šå¢åŠ äº†è¯¦ç»†çš„è¿›åº¦ç›‘æ§

## æŠ€æœ¯è¦ç‚¹

### å…³é”®ä¿®å¤ç‚¹

1. **ä¿å®ˆçš„æ¸…ç†ç­–ç•¥**ï¼šå¤§å¹…å»¶é•¿ä»»åŠ¡ä¿ç•™æ—¶é—´
2. **æ™ºèƒ½å¡æ­»æ£€æµ‹**ï¼šåŸºäºè¿›åº¦æ›´æ–°è€Œéå•çº¯æ—¶é—´
3. **é™ä½å¹²æ‰°é¢‘ç‡**ï¼šå‡å°‘æ¸…ç†æ“ä½œå¯¹è¿è¡Œä»»åŠ¡çš„å½±å“
4. **å¢å¼ºé”™è¯¯å¤„ç†**ï¼šå‰ç«¯æ›´å¥½åœ°å¤„ç†ç½‘ç»œå¼‚å¸¸

### è®¾è®¡åŸåˆ™

- **å®‰å…¨ç¬¬ä¸€**ï¼šå®å¯ä¿ç•™æ— ç”¨ä»»åŠ¡ï¼Œä¹Ÿä¸è¯¯åˆ æœ‰ç”¨ä»»åŠ¡
- **ç”¨æˆ·ä½“éªŒ**ï¼šç¡®ä¿æ‰«æè¿‡ç¨‹çš„è¿ç»­æ€§å’Œå¯é¢„æµ‹æ€§
- **ç³»ç»Ÿç¨³å®š**ï¼šå‡å°‘ä¸å¿…è¦çš„ç³»ç»Ÿå¹²é¢„
- **å¯è§‚æµ‹æ€§**ï¼šå¢å¼ºæ—¥å¿—è®°å½•å’ŒçŠ¶æ€è·Ÿè¸ª

## æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„åˆ†æå’Œä¿®å¤ï¼ŒæˆåŠŸè§£å†³äº†å¸‚åœºæ‰«æåŠŸèƒ½çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†é—®é¢˜ã€‚ä¿®å¤åçš„ç³»ç»Ÿå…·æœ‰ï¼š

- âœ… **é«˜å¯é æ€§**ï¼šä»»åŠ¡ä¸ä¼šæ„å¤–æ¶ˆå¤±
- âœ… **å¼ºç¨³å®šæ€§**ï¼šèƒ½å¤Ÿç¨³å®šå®Œæˆé•¿æ—¶é—´æ‰«æ
- âœ… **å¥½ä½“éªŒ**ï¼šç”¨æˆ·å¯ä»¥æ”¾å¿ƒä½¿ç”¨æ‰«æåŠŸèƒ½
- âœ… **æ˜“ç»´æŠ¤**ï¼šè¯¦ç»†çš„æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

**ä¿®å¤éªŒè¯**ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œç¨³å®šï¼Œç”¨æˆ·é—®é¢˜å®Œå…¨è§£å†³ã€‚

---
*ä¿®å¤å®Œæˆæ—¶é—´ï¼š2025-06-21 19:17*  
*çŠ¶æ€ï¼šâœ… å·²ä¿®å¤å¹¶éªŒè¯*  
*æµ‹è¯•ç»“æœï¼šâœ… å…¨éƒ¨é€šè¿‡*
