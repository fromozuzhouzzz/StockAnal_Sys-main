<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶é€šä¿¡æ¼”ç¤º - è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„CSSå’ŒJSåº“ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <!-- å¼•å…¥å®æ—¶é€šä¿¡å®¢æˆ·ç«¯ -->
    <script src="{{ url_for('static', filename='js/websocket_client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sse_client.js') }}"></script>
    <script src="{{ url_for('static', filename='js/smart_polling.js') }}"></script>
    <script src="{{ url_for('static', filename='js/unified_task_client.js') }}"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .demo-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .button-group {
            margin: 15px 0;
        }
        
        .button-group button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        
        .button-group button:hover {
            background: #0056b3;
        }
        
        .button-group button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
        }
        
        .log-entry.success {
            border-left-color: #28a745;
        }
        
        .log-entry.error {
            border-left-color: #dc3545;
        }
        
        .log-entry.warning {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ å®æ—¶é€šä¿¡æ¼”ç¤º - è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
    
    <!-- é€šä¿¡æ–¹å¼çŠ¶æ€ -->
    <div class="demo-section">
        <h2>ğŸ“¡ é€šä¿¡æ–¹å¼çŠ¶æ€</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="communication-method">æ£€æµ‹ä¸­...</div>
                <div class="stat-label">å½“å‰é€šä¿¡æ–¹å¼</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="connection-status">è¿æ¥ä¸­...</div>
                <div class="stat-label">è¿æ¥çŠ¶æ€</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="subscribed-tasks">0</div>
                <div class="stat-label">è®¢é˜…ä»»åŠ¡æ•°</div>
            </div>
        </div>
    </div>
    
    <!-- ä»»åŠ¡æµ‹è¯• -->
    <div class="demo-section">
        <h2>ğŸ§ª ä»»åŠ¡çŠ¶æ€æµ‹è¯•</h2>
        <div class="button-group">
            <button onclick="startStockAnalysis()">å¯åŠ¨è‚¡ç¥¨åˆ†æä»»åŠ¡</button>
            <button onclick="startMarketScan()">å¯åŠ¨å¸‚åœºæ‰«æä»»åŠ¡</button>
            <button onclick="testRealtimeBroadcast()">æµ‹è¯•å®æ—¶å¹¿æ’­</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div>
            <label for="test-task-id">æµ‹è¯•ä»»åŠ¡ID:</label>
            <input type="text" id="test-task-id" placeholder="è¾“å…¥ä»»åŠ¡IDè¿›è¡Œè®¢é˜…æµ‹è¯•" style="width: 300px; padding: 5px;">
            <button onclick="subscribeTestTask()">è®¢é˜…ä»»åŠ¡</button>
            <button onclick="unsubscribeTestTask()">å–æ¶ˆè®¢é˜…</button>
        </div>
        
        <h3>ğŸ“‹ ä»»åŠ¡çŠ¶æ€æ—¥å¿—</h3>
        <div id="task-logs" class="status-display"></div>
    </div>
    
    <!-- å®æ—¶ç»Ÿè®¡ -->
    <div class="demo-section">
        <h2>ğŸ“Š å®æ—¶ç»Ÿè®¡ä¿¡æ¯</h2>
        <button onclick="refreshStats()">åˆ·æ–°ç»Ÿè®¡</button>
        <div id="stats-display" class="status-display"></div>
    </div>
    
    <!-- ç³»ç»Ÿæ—¥å¿— -->
    <div class="demo-section">
        <h2>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h2>
        <div id="system-logs" class="status-display"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let logCounter = 0;
        let currentTasks = new Set();
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            logMessage('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å®æ—¶é€šä¿¡...', 'info');
            
            // ç­‰å¾…ç»Ÿä¸€ä»»åŠ¡å®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ
            setTimeout(() => {
                updateConnectionStatus();
                refreshStats();
                
                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(updateConnectionStatus, 5000);
                setInterval(refreshStats, 10000);
            }, 2000);
        });
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus() {
            if (window.unifiedTaskClient) {
                const method = window.unifiedTaskClient.getCommunicationMethod();
                const tasks = window.unifiedTaskClient.getSubscribedTasks();
                
                document.getElementById('communication-method').textContent = method ? method.toUpperCase() : 'æœªçŸ¥';
                document.getElementById('subscribed-tasks').textContent = tasks.length;
                
                // æ£€æŸ¥è¿æ¥çŠ¶æ€
                let status = 'æœªçŸ¥';
                if (method === 'websocket' && window.wsTaskClient) {
                    status = window.wsTaskClient.isConnected() ? 'å·²è¿æ¥' : 'æ–­å¼€';
                } else if (method === 'sse') {
                    status = 'å·²è¿æ¥';
                } else if (method === 'polling') {
                    status = 'è½®è¯¢ä¸­';
                }
                
                document.getElementById('connection-status').textContent = status;
            }
        }
        
        // å¯åŠ¨è‚¡ç¥¨åˆ†æä»»åŠ¡
        function startStockAnalysis() {
            const stockCode = '600547'; // æµ‹è¯•è‚¡ç¥¨ä»£ç 
            
            logMessage(`å¯åŠ¨è‚¡ç¥¨åˆ†æä»»åŠ¡: ${stockCode}`, 'info');
            
            $.ajax({
                url: '/api/start_stock_analysis',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    stock_code: stockCode,
                    market_type: 'A'
                }),
                success: function(response) {
                    const taskId = response.task_id;
                    logMessage(`âœ“ è‚¡ç¥¨åˆ†æä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${taskId}`, 'success');
                    
                    // è®¢é˜…ä»»åŠ¡çŠ¶æ€
                    subscribeTask(taskId, 'stock_analysis');
                },
                error: function(xhr, status, error) {
                    logMessage(`âœ— è‚¡ç¥¨åˆ†æä»»åŠ¡åˆ›å»ºå¤±è´¥: ${error}`, 'error');
                }
            });
        }
        
        // å¯åŠ¨å¸‚åœºæ‰«æä»»åŠ¡
        function startMarketScan() {
            logMessage('å¯åŠ¨å¸‚åœºæ‰«æä»»åŠ¡...', 'info');
            
            $.ajax({
                url: '/api/start_market_scan',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    industry: 'ä¿é™©',
                    min_score: 7.0,
                    max_results: 10
                }),
                success: function(response) {
                    const taskId = response.task_id;
                    logMessage(`âœ“ å¸‚åœºæ‰«æä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${taskId}`, 'success');
                    
                    // è®¢é˜…ä»»åŠ¡çŠ¶æ€
                    subscribeTask(taskId, 'market_scan');
                },
                error: function(xhr, status, error) {
                    logMessage(`âœ— å¸‚åœºæ‰«æä»»åŠ¡åˆ›å»ºå¤±è´¥: ${error}`, 'error');
                }
            });
        }
        
        // è®¢é˜…ä»»åŠ¡çŠ¶æ€
        function subscribeTask(taskId, taskType) {
            if (!window.unifiedTaskClient) {
                logMessage('ç»Ÿä¸€ä»»åŠ¡å®¢æˆ·ç«¯ä¸å¯ç”¨', 'error');
                return;
            }
            
            currentTasks.add(taskId);
            
            const success = window.unifiedTaskClient.subscribeTask(taskId, function(data) {
                logMessage(`ğŸ“¨ ä»»åŠ¡ ${taskId} çŠ¶æ€æ›´æ–°: ${data.status} (${data.progress}%)`, 'info');
                
                if (['completed', 'failed', 'cancelled'].includes(data.status)) {
                    logMessage(`ğŸ ä»»åŠ¡ ${taskId} å·²å®Œæˆ: ${data.status}`, data.status === 'completed' ? 'success' : 'error');
                    currentTasks.delete(taskId);
                }
            });
            
            if (success) {
                logMessage(`âœ“ æˆåŠŸè®¢é˜…ä»»åŠ¡: ${taskId}`, 'success');
            } else {
                logMessage(`âœ— è®¢é˜…ä»»åŠ¡å¤±è´¥: ${taskId}`, 'error');
            }
        }
        
        // è®¢é˜…æµ‹è¯•ä»»åŠ¡
        function subscribeTestTask() {
            const taskId = document.getElementById('test-task-id').value.trim();
            if (!taskId) {
                alert('è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }
            
            subscribeTask(taskId, 'test');
        }
        
        // å–æ¶ˆè®¢é˜…æµ‹è¯•ä»»åŠ¡
        function unsubscribeTestTask() {
            const taskId = document.getElementById('test-task-id').value.trim();
            if (!taskId) {
                alert('è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }
            
            if (window.unifiedTaskClient) {
                window.unifiedTaskClient.unsubscribeTask(taskId);
                currentTasks.delete(taskId);
                logMessage(`å–æ¶ˆè®¢é˜…ä»»åŠ¡: ${taskId}`, 'warning');
            }
        }
        
        // æµ‹è¯•å®æ—¶å¹¿æ’­
        function testRealtimeBroadcast() {
            const testTaskId = `test_${Date.now()}`;
            
            $.ajax({
                url: `/api/realtime/test/${testTaskId}`,
                method: 'GET',
                success: function(response) {
                    logMessage(`âœ“ å®æ—¶å¹¿æ’­æµ‹è¯•å®Œæˆ: ${JSON.stringify(response, null, 2)}`, 'success');
                },
                error: function(xhr, status, error) {
                    logMessage(`âœ— å®æ—¶å¹¿æ’­æµ‹è¯•å¤±è´¥: ${error}`, 'error');
                }
            });
        }
        
        // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        function refreshStats() {
            $.ajax({
                url: '/api/realtime/stats',
                method: 'GET',
                success: function(stats) {
                    document.getElementById('stats-display').textContent = JSON.stringify(stats, null, 2);
                },
                error: function(xhr, status, error) {
                    document.getElementById('stats-display').textContent = `è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error}`;
                }
            });
        }
        
        // è®°å½•æ—¥å¿—æ¶ˆæ¯
        function logMessage(message, type = 'info') {
            logCounter++;
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const logsContainer = document.getElementById('task-logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type}`;
            logDiv.textContent = logEntry;
            
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // åŒæ—¶è®°å½•åˆ°ç³»ç»Ÿæ—¥å¿—
            const systemLogs = document.getElementById('system-logs');
            const systemLogDiv = logDiv.cloneNode(true);
            systemLogs.appendChild(systemLogDiv);
            systemLogs.scrollTop = systemLogs.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('task-logs').innerHTML = '';
            document.getElementById('system-logs').innerHTML = '';
            logCounter = 0;
        }
        
        // ç›‘å¬å…¨å±€ä»»åŠ¡çŠ¶æ€æ›´æ–°äº‹ä»¶
        window.addEventListener('taskStatusUpdate', function(event) {
            const data = event.detail;
            logMessage(`ğŸŒ å…¨å±€ä»»åŠ¡çŠ¶æ€æ›´æ–°: ${data.task_id} -> ${data.status}`, 'info');
        });
        
        // ç›‘å¬ä»»åŠ¡ä¸å­˜åœ¨äº‹ä»¶
        window.addEventListener('taskNotFound', function(event) {
            const taskId = event.detail.task_id;
            logMessage(`âš ï¸ ä»»åŠ¡ä¸å­˜åœ¨: ${taskId}`, 'warning');
            currentTasks.delete(taskId);
        });
    </script>
</body>
</html>
