{% extends "layout.html" %}

{% block title %}è‚¡ç¥¨è¯¦æƒ… - {{ stock_code }} - æ™ºèƒ½åˆ†æç³»ç»Ÿ{% endblock %}

{% block head %}
<style>
    /* Enhanced Material Design 3 Stock Detail Styles */
    .stock-detail-header {
        background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-secondary-container) 100%);
        border-radius: var(--md-sys-shape-corner-large);
        padding: 32px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
    }

    .stock-detail-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(50%, -50%);
    }

    .stock-price-display {
        font-family: var(--md-sys-typescale-financial-large-font);
        font-size: var(--md-sys-typescale-financial-large-size);
        font-weight: var(--md-sys-typescale-financial-large-weight);
        color: var(--md-sys-color-on-primary-container);
        margin-bottom: 8px;
    }

    .stock-change-display {
        font-family: var(--md-sys-typescale-financial-medium-font);
        font-size: var(--md-sys-typescale-financial-medium-size);
        font-weight: var(--md-sys-typescale-financial-medium-weight);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stock-controls {
        display: flex;
        gap: 16px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* è¯„åˆ†åŠ è½½çŠ¶æ€æ ·å¼ */
    .score-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        opacity: 0.7;
    }

    .score-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        color: var(--md-sys-color-error);
    }

    .score-error .material-icons {
        margin-bottom: 16px;
        opacity: 0.6;
    }

    /* è¯„åˆ†åŠ è½½åŠ¨ç”» */
    @keyframes scoreLoading {
        0% { opacity: 0.3; }
        50% { opacity: 0.8; }
        100% { opacity: 0.3; }
    }

    .score-loading .shimmer-skeleton {
        animation: scoreLoading 1.5s ease-in-out infinite;
    }
    }

    .stock-metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 32px;
    }

    @media (max-width: 768px) {
        .stock-metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¯„åˆ†æ˜ç»†æ ·å¼ä¼˜åŒ– */
        .score-details-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .score-progress-container {
            width: 100%;
            min-width: unset;
        }

        .score-dimension-name {
            font-size: 14px;
        }

        /* ç§»åŠ¨ç«¯è¯¦æƒ…é¢æ¿ä¼˜åŒ– */
        .indicators-grid {
            grid-template-columns: 1fr;
        }

        .score-detail-toggle {
            width: 36px;
            height: 36px;
        }

        .score-detail-content {
            padding: 12px;
        }

        .score-detail-title {
            font-size: 16px;
        }

        /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¯„åˆ†æ˜ç»†å®¹å™¨è°ƒæ•´ */
        #score-details-container.expanded {
            max-height: 1000px; /* ç§»åŠ¨è®¾å¤‡éœ€è¦æ›´å¤šç©ºé—´ */
        }

        .score-dimension-desc {
            font-size: 12px;
            line-height: 1.3;
        }

        .score-weight-display {
            display: block;
            margin-left: 0;
            margin-top: 4px;
        }

        .score-details-summary {
            padding: 12px;
        }

        .score-details-summary h4 {
            font-size: 16px;
        }

        .score-details-summary p {
            font-size: 12px;
        }
    }

    @media (max-width: 480px) {
        /* è¶…å°å±å¹•è®¾å¤‡ä¼˜åŒ– */
        .score-progress-container {
            flex-direction: column;
            gap: 8px;
        }

        .score-progress-bar {
            width: 100%;
        }

        .score-value-display {
            text-align: center;
            min-width: unset;
        }
    }

    .metric-card {
        background: var(--md-sys-color-surface-container);
        border-radius: var(--md-sys-shape-corner-medium);
        padding: 24px;
        text-align: center;
        transition: all var(--md-sys-motion-duration-medium2) var(--md-sys-motion-easing-standard);
        border: 1px solid var(--md-sys-color-outline-variant);
    }

    .metric-card:hover {
        background: var(--md-sys-color-surface-container-high);
        transform: translateY(-4px);
        box-shadow: var(--md-sys-elevation-level2);
    }

    .metric-value {
        font-family: var(--md-sys-typescale-financial-medium-font);
        font-size: var(--md-sys-typescale-financial-medium-size);
        font-weight: var(--md-sys-typescale-financial-medium-weight);
        color: var(--md-sys-color-on-surface);
        margin-bottom: 8px;
    }

    .metric-label {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
    }

    .chart-tabs {
        margin-bottom: 32px;
    }

    .chart-container {
        background: var(--md-sys-color-surface);
        border-radius: var(--md-sys-shape-corner-large);
        border: 1px solid var(--md-sys-color-outline-variant);
        overflow: hidden;
    }

    .ai-analysis-section {
        background: var(--md-sys-color-surface-container-low);
        border-radius: var(--md-sys-shape-corner-large);
        padding: 32px;
        position: relative;
        min-height: 300px;
    }

    .ai-loader {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(var(--md-sys-color-surface-rgb), 0.9);
        backdrop-filter: blur(8px);
        border-radius: var(--md-sys-shape-corner-large);
        z-index: 10;
    }

    .typing-animation {
        display: flex;
        gap: 4px;
        margin-top: 16px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--md-sys-color-primary);
        border-radius: 50%;
        animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typing-bounce {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1.2); opacity: 1; }
    }

    .shimmer-skeleton {
        background: linear-gradient(90deg, var(--md-sys-color-surface-container) 25%, var(--md-sys-color-surface-container-high) 50%, var(--md-sys-color-surface-container) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--md-sys-shape-corner-small);
    }

    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }

    .score-circle {
        position: relative;
        width: 160px;
        height: 160px;
        margin: 0 auto;
    }

    .score-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .score-number {
        font-family: var(--md-sys-typescale-financial-large-font);
        font-size: 48px;
        font-weight: var(--md-sys-typescale-financial-large-weight);
        color: var(--md-sys-color-primary);
        line-height: 1;
    }

    .score-text {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
        margin-top: 4px;
    }

    .support-resistance-table {
        width: 100%;
        border-collapse: collapse;
    }

    /* è¯„åˆ†æ˜ç»†æ ·å¼ */
    .score-details-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }

    .score-details-item:last-child {
        border-bottom: none;
    }

    .score-dimension {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .score-dimension-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .score-dimension-name {
        font-family: var(--md-sys-typescale-body-medium-font);
        font-size: var(--md-sys-typescale-body-medium-size);
        font-weight: var(--md-sys-typescale-body-medium-weight);
        color: var(--md-sys-color-on-surface);
        display: flex;
        align-items: center;
    }

    .score-dimension-desc {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
    }

    .score-progress-container {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 200px;
    }

    .score-progress-bar {
        flex: 1;
        height: 8px;
        background-color: var(--md-sys-color-surface-variant);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }

    .score-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-secondary));
        border-radius: 4px;
        transition: width 0.6s ease;
    }

    .score-value-display {
        font-family: var(--md-sys-typescale-label-medium-font);
        font-size: var(--md-sys-typescale-label-medium-size);
        font-weight: var(--md-sys-typescale-label-medium-weight);
        color: var(--md-sys-color-primary);
        min-width: 40px;
        text-align: right;
    }

    .score-weight-display {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
        margin-left: 8px;
    }

    /* è¯„åˆ†è¯¦æƒ…æŒ‰é’®æ ·å¼ */
    .score-detail-toggle {
        width: 40px;
        height: 40px;
        border-radius: 20px;
        border: none;
        background: var(--md-sys-color-surface-variant);
        color: var(--md-sys-color-on-surface-variant);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .score-detail-toggle:hover {
        background: var(--md-sys-color-primary-container);
        color: var(--md-sys-color-on-primary-container);
    }

    .score-detail-toggle:active {
        transform: scale(0.95);
    }

    /* è¯„åˆ†è¯¦æƒ…é¢æ¿æ ·å¼ */
    .score-detail-panel {
        margin-top: 16px;
        background: var(--md-sys-color-surface-container-low);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--md-sys-color-outline-variant);
    }

    .score-detail-content {
        padding: 16px;
    }

    .score-detail-title {
        font-family: var(--md-sys-typescale-title-small-font);
        font-size: var(--md-sys-typescale-title-small-size);
        font-weight: var(--md-sys-typescale-title-small-weight);
        color: var(--md-sys-color-on-surface);
        margin: 0 0 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .score-indicators-section,
    .score-logic-section {
        margin-bottom: 16px;
    }

    .score-indicators-section:last-child,
    .score-logic-section:last-child {
        margin-bottom: 0;
    }

    .score-indicators-section h6,
    .score-logic-section h6 {
        font-family: var(--md-sys-typescale-label-large-font);
        font-size: var(--md-sys-typescale-label-large-size);
        font-weight: var(--md-sys-typescale-label-large-weight);
        color: var(--md-sys-color-primary);
        margin: 0 0 8px 0;
    }

    .indicators-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
    }

    .indicator-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--md-sys-color-surface-container);
        border-radius: 8px;
        border: 1px solid var(--md-sys-color-outline-variant);
    }

    .indicator-name {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
    }

    .indicator-value {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        font-weight: 500;
        color: var(--md-sys-color-on-surface);
    }

    .logic-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .logic-item {
        padding: 8px 12px;
        background: var(--md-sys-color-surface-container);
        border-radius: 8px;
        border-left: 3px solid var(--md-sys-color-primary);
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface);
        line-height: 1.4;
    }

    .score-details-summary {
        background-color: var(--md-sys-color-surface-container-high);
        border-radius: var(--md-sys-shape-corner-medium);
        padding: 16px;
        margin-bottom: 16px;
    }

    .score-details-summary h4 {
        font-family: var(--md-sys-typescale-title-small-font);
        font-size: var(--md-sys-typescale-title-small-size);
        color: var(--md-sys-color-on-surface);
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .score-details-summary p {
        font-family: var(--md-sys-typescale-body-small-font);
        font-size: var(--md-sys-typescale-body-small-size);
        color: var(--md-sys-color-on-surface-variant);
        margin: 0;
        line-height: 1.4;
    }

    /* è¯„åˆ†æ˜ç»†å®¹å™¨åŠ¨ç”»æ ·å¼ */
    #score-details-container {
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out;
        max-height: 0;
        opacity: 0;
        will-change: max-height, opacity;
    }

    #score-details-container.expanded {
        max-height: 800px; /* è¶³å¤Ÿå®¹çº³æ‰€æœ‰è¯„åˆ†æ˜ç»†å†…å®¹ */
        opacity: 1;
    }

    /* ç¡®ä¿è¯„åˆ†æ˜ç»†å±•å¼€æ—¶ä¸å½±å“å…¶ä»–å…ƒç´ å¸ƒå±€ */
    .md3-card-body {
        position: relative;
    }

    /* è¯„åˆ†æ˜ç»†æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    #score-details-toggle .md3-button {
        transition: all 0.2s ease;
    }

    #score-details-toggle .md3-button:hover {
        background-color: var(--md-sys-color-surface-container-high);
    }

    /* ç¡®ä¿è¯„åˆ†æ˜ç»†å†…å®¹åœ¨åŠ¨ç”»æœŸé—´ä¸ä¼šæº¢å‡º */
    #score-details-container > * {
        transform: translateZ(0); /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
    }

    .support-resistance-table th,
    .support-resistance-table td {
        padding: 12px 16px;
        text-align: center;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
    }

    .support-resistance-table th {
        background: var(--md-sys-color-surface-container);
        color: var(--md-sys-color-on-surface);
        font-family: var(--md-sys-typescale-title-small-font);
        font-size: var(--md-sys-typescale-title-small-size);
        font-weight: var(--md-sys-typescale-title-small-weight);
    }

    .trend-indicator {
        padding: 8px 16px;
        border-radius: var(--md-sys-shape-corner-small);
        font-family: var(--md-sys-typescale-label-medium-font);
        font-size: var(--md-sys-typescale-label-medium-size);
        font-weight: var(--md-sys-typescale-label-medium-weight);
    }

    .trend-up {
        background: var(--md-sys-color-bull-container);
        color: var(--md-sys-color-on-bull-container);
        border-left: 4px solid var(--md-sys-color-bull);
    }

    .trend-down {
        background: var(--md-sys-color-bear-container);
        color: var(--md-sys-color-on-bear-container);
        border-left: 4px solid var(--md-sys-color-bear);
    }

    /* Enhanced Material Design 3 Tab Styles */
    .md3-tab-bar {
        display: flex;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
        background-color: var(--md-sys-color-surface);
        border-radius: var(--md-sys-shape-corner-large) var(--md-sys-shape-corner-large) 0 0;
        overflow: hidden;
    }

    .md3-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px 24px;
        border: none;
        background: none;
        color: var(--md-sys-color-on-surface-variant);
        font-family: var(--md-sys-typescale-title-small-font);
        font-size: var(--md-sys-typescale-title-small-size);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--md-sys-motion-duration-short4) var(--md-sys-motion-easing-standard);
        border-bottom: 3px solid transparent;
        flex: 1;
        justify-content: center;
        min-height: 48px;
    }

    .md3-tab:hover {
        background-color: var(--md-sys-color-surface-container-high);
        color: var(--md-sys-color-on-surface);
    }

    .md3-tab.md3-tab-active {
        color: var(--md-sys-color-primary);
        border-bottom-color: var(--md-sys-color-primary);
        background-color: var(--md-sys-color-primary-container);
    }

    .md3-tab-content {
        margin-top: 0;
    }

    .md3-tab-panel {
        display: none;
    }

    .md3-tab-panel.md3-tab-panel-active {
        display: block;
    }

    /* Tab Icons */
    .md3-tab i {
        font-size: 20px;
    }

    /* Responsive Tab Design */
    @media (max-width: 768px) {
        .md3-tab {
            padding: 12px 16px;
            font-size: 14px;
        }

        .md3-tab span {
            display: none;
        }

        .md3-tab i {
            font-size: 18px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-transition">
    <div id="alerts-container"></div>

    <!-- Enhanced Material Design 3 è‚¡ç¥¨è¯¦æƒ…å¤´éƒ¨ -->
    <div class="stock-detail-header md3-animate-fade-in">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 1;">
            <div style="flex: 1;">
                <div id="stock-title" style="margin-bottom: 16px;">
                    <div class="shimmer-skeleton" style="width: 300px; height: 32px; margin-bottom: 8px;"></div>
                    <div class="shimmer-skeleton" style="width: 200px; height: 20px;"></div>
                </div>
                <div id="stock-price-section" style="margin-bottom: 24px;">
                    <div id="price-container">
                        <div class="shimmer-skeleton" style="width: 200px; height: 48px; margin-bottom: 8px;"></div>
                        <div class="shimmer-skeleton" style="width: 150px; height: 24px;"></div>
                    </div>
                </div>
                <div id="stock-basic-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;">
                    <div>
                        <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.7; font-size: 14px; margin-bottom: 4px;">ä»Šå¼€</div>
                        <div id="open-price" class="shimmer-skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                    <div>
                        <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.7; font-size: 14px; margin-bottom: 4px;">æœ€é«˜</div>
                        <div id="high-price" class="shimmer-skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                    <div>
                        <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.7; font-size: 14px; margin-bottom: 4px;">æœ€ä½</div>
                        <div id="low-price" class="shimmer-skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                    <div>
                        <div style="color: var(--md-sys-color-on-primary-container); opacity: 0.7; font-size: 14px; margin-bottom: 4px;">æˆäº¤é‡</div>
                        <div id="volume-info" class="shimmer-skeleton" style="width: 80px; height: 20px;"></div>
                    </div>
                </div>
            </div>
            <div class="stock-controls">
                <div class="md3-text-field md3-text-field-outlined md3-text-field-small">
                    <select class="md3-text-field-input" id="market-type">
                        <option value="A" {% if market_type == 'A' %}selected{% endif %}>Aè‚¡</option>
                        <option value="HK" {% if market_type == 'HK' %}selected{% endif %}>æ¸¯è‚¡</option>
                        <option value="US" {% if market_type == 'US' %}selected{% endif %}>ç¾è‚¡</option>
                    </select>
                    <label class="md3-text-field-label">å¸‚åœº</label>
                </div>
                <div class="md3-text-field md3-text-field-outlined md3-text-field-small">
                    <select class="md3-text-field-input" id="analysis-period">
                        <option value="1m">1ä¸ªæœˆ</option>
                        <option value="3m">3ä¸ªæœˆ</option>
                        <option value="6m">6ä¸ªæœˆ</option>
                        <option value="1y" selected>1å¹´</option>
                    </select>
                    <label class="md3-text-field-label">å‘¨æœŸ</label>
                </div>
                <button id="refresh-btn" class="md3-button md3-button-filled md3-button-small">
                    <i class="material-icons">refresh</i>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Material Design 3 ç³»ç»ŸæŒ‡æ ‡åŒºåŸŸ -->
    <div id="system-indicators">
        <!-- ç»¼åˆè¯„åˆ†å’Œå…³é”®æŒ‡æ ‡ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px;">
            <!-- ç»¼åˆè¯„åˆ†å¡ç‰‡ -->
            <div class="md3-card md3-card-elevated md3-animate-slide-in-left">
                <div class="md3-card-header">
                    <h3 class="md3-card-title">
                        <i class="material-icons">analytics</i> ç»¼åˆè¯„åˆ†
                    </h3>
                    <p class="md3-card-subtitle">åŸºäºå¤šç»´åº¦åˆ†æçš„æŠ•èµ„è¯„åˆ†</p>
                </div>
                <div class="md3-card-body" style="text-align: center; padding: 32px;">
                    <div id="score-container">
                        <div class="score-circle">
                            <div class="shimmer-skeleton" style="width: 160px; height: 160px; border-radius: 50%;"></div>
                            <div class="score-display">
                                <div class="shimmer-skeleton" style="width: 60px; height: 48px; margin: 0 auto 8px;"></div>
                                <div class="shimmer-skeleton" style="width: 80px; height: 16px; margin: 0 auto;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="recommendation-container" style="margin-top: 24px;">
                        <div class="shimmer-skeleton" style="width: 120px; height: 32px; margin: 0 auto;"></div>
                    </div>

                    <!-- è¯„åˆ†æ˜ç»†å±•å¼€/æ”¶èµ·æŒ‰é’® -->
                    <div id="score-details-toggle" style="margin-top: 24px; display: none;">
                        <button class="md3-button md3-button-text" onclick="toggleScoreDetails()">
                            <i class="material-icons" id="score-details-icon">expand_more</i>
                            <span id="score-details-text">æŸ¥çœ‹è¯„åˆ†æ˜ç»†</span>
                        </button>
                    </div>

                    <!-- è¯„åˆ†æ˜ç»†åŒºåŸŸ -->
                    <div id="score-details-container" style="margin-top: 24px; text-align: left;">
                        <!-- è¯„åˆ†æ˜ç»†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
            <div class="md3-card md3-card-elevated md3-animate-slide-in-right">
                <div class="md3-card-header">
                    <h3 class="md3-card-title">
                        <i class="material-icons">speed</i> å…³é”®æŒ‡æ ‡
                    </h3>
                    <p class="md3-card-subtitle">é‡è¦æŠ€æœ¯æŒ‡æ ‡å¿«é€Ÿæ¦‚è§ˆ</p>
                </div>
                <div class="md3-card-body">
                    <div class="stock-metrics-grid">
                        <div class="metric-card" id="rsi-container">
                            <div class="shimmer-skeleton" style="width: 60px; height: 24px; margin: 0 auto 8px;"></div>
                            <div class="shimmer-skeleton" style="width: 40px; height: 16px; margin: 0 auto;"></div>
                        </div>
                        <div class="metric-card" id="ma-trend-container">
                            <div class="shimmer-skeleton" style="width: 60px; height: 24px; margin: 0 auto 8px;"></div>
                            <div class="shimmer-skeleton" style="width: 40px; height: 16px; margin: 0 auto;"></div>
                        </div>
                        <div class="metric-card" id="macd-container">
                            <div class="shimmer-skeleton" style="width: 60px; height: 24px; margin: 0 auto 8px;"></div>
                            <div class="shimmer-skeleton" style="width: 40px; height: 16px; margin: 0 auto;"></div>
                        </div>
                        <div class="metric-card" id="volume-trend-container">
                            <div class="shimmer-skeleton" style="width: 60px; height: 24px; margin: 0 auto 8px;"></div>
                            <div class="shimmer-skeleton" style="width: 40px; height: 16px; margin: 0 auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Material Design 3 å›¾è¡¨åŒºåŸŸ -->
        <div class="md3-card md3-card-elevated chart-container md3-animate-fade-in" style="margin-bottom: 32px;">
            <div class="md3-card-header">
                <h3 class="md3-card-title">
                    <i class="material-icons">show_chart</i> æŠ€æœ¯åˆ†æå›¾è¡¨
                </h3>
                <p class="md3-card-subtitle">ä»·æ ¼èµ°åŠ¿ä¸æŠ€æœ¯æŒ‡æ ‡åˆ†æ</p>
            </div>

            <!-- Enhanced Material Design 3 Chart Tabs -->
            <div class="chart-tabs">
                <div class="md3-tabs">
                    <div class="md3-tab-bar">
                        <button class="md3-tab md3-tab-active" id="price-tab" data-target="price-content">
                            <i class="material-icons">candlestick_chart</i>
                            <span>ä»·æ ¼è¶‹åŠ¿</span>
                        </button>
                        <button class="md3-tab" id="indicators-tab" data-target="indicators-content">
                            <i class="material-icons">analytics</i>
                            <span>æŠ€æœ¯æŒ‡æ ‡</span>
                        </button>
                        <button class="md3-tab" id="volume-tab" data-target="volume-content">
                            <i class="material-icons">bar_chart</i>
                            <span>æˆäº¤é‡</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="md3-card-body" style="padding: 0;">
                <div class="md3-tab-content">
                    <div class="md3-tab-panel md3-tab-panel-active" id="price-content">
                        <div id="price-chart" style="height: 450px; padding: 16px;"></div>
                    </div>
                    <div class="md3-tab-panel" id="indicators-content">
                        <div id="indicators-chart" style="height: 450px; padding: 16px;"></div>
                    </div>
                    <div class="md3-tab-panel" id="volume-content">
                        <div id="volume-chart" style="height: 450px; padding: 16px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Material Design 3 æ”¯æ’‘å‹åŠ›ä½å’Œé›·è¾¾å›¾ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px;">
            <!-- æ”¯æ’‘ä¸å‹åŠ›ä½å¡ç‰‡ -->
            <div class="md3-card md3-card-elevated md3-animate-slide-in-left">
                <div class="md3-card-header">
                    <h3 class="md3-card-title">
                        <i class="material-icons">support</i> æ”¯æ’‘ä¸å‹åŠ›ä½
                    </h3>
                    <p class="md3-card-subtitle">å…³é”®ä»·æ ¼æ”¯æ’‘ä¸é˜»åŠ›ä½åˆ†æ</p>
                </div>
                <div class="md3-card-body">
                    <div id="support-resistance-container">
                        <div class="shimmer-skeleton" style="width: 100%; height: 200px;"></div>
                    </div>
                </div>
            </div>

            <!-- å¤šç»´åº¦è¯„åˆ†å¡ç‰‡ -->
            <div class="md3-card md3-card-elevated md3-animate-slide-in-right">
                <div class="md3-card-header">
                    <h3 class="md3-card-title">
                        <i class="material-icons">radar</i> å¤šç»´åº¦è¯„åˆ†
                    </h3>
                    <p class="md3-card-subtitle">æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€èµ„é‡‘é¢ç»¼åˆåˆ†æ</p>
                </div>
                <div class="md3-card-body">
                    <div id="radar-chart-container">
                        <div class="shimmer-skeleton" style="width: 100%; height: 250px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Material Design 3 AIåˆ†æåŒºåŸŸ -->
    <div class="md3-card md3-card-elevated md3-animate-slide-in-up">
        <div class="md3-card-header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                    <h3 class="md3-card-title">
                        <i class="material-icons">psychology</i> AIæ™ºèƒ½åˆ†ææŠ¥å‘Š
                    </h3>
                    <p class="md3-card-subtitle">åŸºäºæ·±åº¦å­¦ä¹ çš„è‚¡ç¥¨æŠ•èµ„åˆ†æ</p>
                </div>
                <div>
                    <span id="ai-analysis-status" class="md3-badge md3-badge-info">å‡†å¤‡åˆ†æ...</span>
                </div>
            </div>
        </div>
        <div class="md3-card-body">
            <div class="ai-analysis-section">
                <!-- Enhanced Material Design 3 AIåˆ†æåŠ è½½åŠ¨ç”» -->
                <div id="ai-analysis-loader" class="ai-loader">
                    <div class="md3-progress-indicator" style="margin-bottom: 24px;"></div>
                    <h4 style="color: var(--md-sys-color-on-surface); font-family: var(--md-sys-typescale-title-medium-font); font-size: var(--md-sys-typescale-title-medium-size); font-weight: 500; margin-bottom: 16px;">
                        æ­£åœ¨å¯¹ <span id="ai-analysis-stock-name" style="color: var(--md-sys-color-primary);">è¯¥è‚¡ç¥¨</span> è¿›è¡Œæ™ºèƒ½åˆ†æ
                    </h4>
                    <p style="color: var(--md-sys-color-on-surface-variant); font-family: var(--md-sys-typescale-body-medium-font); font-size: var(--md-sys-typescale-body-medium-size); margin-bottom: 8px;">
                        å·²ç”¨æ—¶ <span id="ai-processing-time" style="color: var(--md-sys-color-primary); font-weight: 500;">0</span> ç§’
                    </p>
                    <p id="ai-analysis-tips" style="color: var(--md-sys-color-on-surface-variant); font-family: var(--md-sys-typescale-body-small-font); font-size: var(--md-sys-typescale-body-small-size); margin-bottom: 16px; font-style: italic;">
                        æ­£åœ¨åˆ†ææŠ€æœ¯æŒ‡æ ‡å’ŒåŸºæœ¬é¢æ•°æ®...
                    </p>
                    <div class="typing-animation">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <div style="width: 300px; height: 8px; background: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-small); margin: 24px 0; overflow: hidden;">
                        <div id="ai-progress-bar" style="height: 100%; background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-secondary)); width: 0%; transition: width var(--md-sys-motion-duration-medium2) var(--md-sys-motion-easing-standard);"></div>
                    </div>
                    <button id="cancel-analysis-btn" class="md3-button md3-button-outlined md3-button-small">
                        <i class="material-icons">close</i> å–æ¶ˆåˆ†æ
                    </button>
                </div>

                <!-- AIåˆ†æå†…å®¹ -->
                <div id="ai-analysis-content" style="opacity: 0; transition: opacity var(--md-sys-motion-duration-medium2) var(--md-sys-motion-easing-standard);">
                    <div id="ai-analysis" style="font-family: var(--md-sys-typescale-body-large-font); font-size: var(--md-sys-typescale-body-large-size); line-height: 1.6; color: var(--md-sys-color-on-surface);">
                        <!-- AIåˆ†æå†…å®¹å°†å¼‚æ­¥å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Material Design 3 é”™è¯¯é‡è¯•åŒºåŸŸ -->
    <div id="error-retry" style="display: none; margin-top: 32px;">
        <div class="md3-card md3-card-elevated" style="background: var(--md-sys-color-error-container); border: 1px solid var(--md-sys-color-error);">
            <div class="md3-card-body" style="text-align: center; padding: 32px;">
                <i class="material-icons" style="font-size: 48px; color: var(--md-sys-color-on-error-container); margin-bottom: 16px;">warning</i>
                <h4 style="color: var(--md-sys-color-on-error-container); font-family: var(--md-sys-typescale-title-medium-font); font-size: var(--md-sys-typescale-title-medium-size); font-weight: 500; margin-bottom: 16px;">åˆ†æè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯</h4>
                <button id="retry-button" class="md3-button md3-button-filled">
                    <i class="material-icons">refresh</i> é‡è¯•åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const stockCode = '{{ stock_code }}';
    let marketType = '{{ market_type }}';
    let period = '1y';
    let stockData = [];
    let analysisResult = null;
    let processingTimer;
    let processingTime = 0;
    
    // é¡µé¢åŠ è½½æ—¶çš„é—ªçƒæ•ˆæœ
    function addShimmerEffect() {
        let style = document.createElement('style');
        style.innerHTML = `
            .shimmer-bg {
                background: #f6f7f8;
                background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
                background-repeat: no-repeat;
                background-size: 800px 104px;
                display: inline-block;
                position: relative;
                animation-duration: 1.5s;
                animation-fill-mode: forwards;
                animation-iteration-count: infinite;
                animation-name: shimmer;
                animation-timing-function: linear;
                border-radius: 4px;
            }
            @keyframes shimmer {
                0% { background-position: -468px 0 }
                100% { background-position: 468px 0 }
            }
        `;
        document.head.appendChild(style);
    }

    $(document).ready(function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è‚¡ç¥¨è¯¦æƒ…é¡µé¢');

        // æ¸…ç†å¯èƒ½æ®‹ç•™çš„è½®è¯¢çŠ¶æ€
        cleanupPollingState();

        addShimmerEffect();

        // åˆå§‹åŠ è½½
        loadStockData();

        // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#refresh-btn').click(function() {
            console.log('ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®');
            marketType = $('#market-type').val();
            period = $('#analysis-period').val();
            loadStockData();
        });

        // å¸‚åœºç±»å‹æ”¹å˜äº‹ä»¶
        $('#market-type').change(function() {
            marketType = $(this).val();
            console.log(`å¸‚åœºç±»å‹å˜æ›´ä¸º: ${marketType}`);
        });

        // åˆ†æå‘¨æœŸæ”¹å˜äº‹ä»¶
        $('#analysis-period').change(function() {
            period = $(this).val();
            console.log(`åˆ†æå‘¨æœŸå˜æ›´ä¸º: ${period}`);
        });

        // å–æ¶ˆåˆ†ææŒ‰é’®
        $('#cancel-analysis-btn').click(function() {
            console.log('ç”¨æˆ·ç‚¹å‡»å–æ¶ˆåˆ†ææŒ‰é’®');
            cancelAnalysis();
        });

        // é‡è¯•æŒ‰é’®
        $('#retry-button').click(function() {
            console.log('ç”¨æˆ·ç‚¹å‡»é‡è¯•æŒ‰é’®');
            $('#error-retry').hide();
            startAIAnalysis();
        });

        // é¡µé¢ç¦»å¼€æ—¶æ¸…ç†çŠ¶æ€
        $(window).on('beforeunload', function() {
            console.log('é¡µé¢å³å°†ç¦»å¼€ï¼Œæ¸…ç†è½®è¯¢çŠ¶æ€');
            cleanupPollingState();
        });

        // é¡µé¢éšè—æ—¶ä¸æ¸…ç†çŠ¶æ€ï¼Œä¿æŒä»»åŠ¡è¿ç»­æ€§
        $(document).on('visibilitychange', function() {
            if (document.hidden) {
                console.log('é¡µé¢éšè—ï¼Œä½†ä¿æŒè½®è¯¢çŠ¶æ€ä»¥ç¡®ä¿ä»»åŠ¡è¿ç»­æ€§');
            } else {
                console.log('é¡µé¢é‡æ–°æ˜¾ç¤ºï¼Œè½®è¯¢çŠ¶æ€ä¿æŒä¸å˜');
            }
        });

        // Enhanced Material Design 3 Tab functionality
        $('.md3-tab').click(function() {
            console.log('æ ‡ç­¾åˆ‡æ¢è¢«ç‚¹å‡»:', $(this).attr('id'));
            const targetId = $(this).data('target');
            console.log('ç›®æ ‡é¢æ¿ID:', targetId);

            // Remove active class from all tabs and panels
            $('.md3-tab').removeClass('md3-tab-active');
            $('.md3-tab-panel').removeClass('md3-tab-panel-active');

            // Add active class to clicked tab and corresponding panel
            $(this).addClass('md3-tab-active');
            $(`#${targetId}`).addClass('md3-tab-panel-active');

            console.log('æ ‡ç­¾åˆ‡æ¢å®Œæˆï¼Œå½“å‰æ¿€æ´»é¢æ¿:', targetId);
        });
    });

    // åŠ è½½è‚¡ç¥¨æ•°æ®
    function loadStockData() {
        resetUI();
        showSystemLoadingState();
        
        // è·å–è‚¡ç¥¨æ•°æ®
        $.ajax({
            url: `/api/stock_data?stock_code=${stockCode}&market_type=${marketType}&period=${period}`,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (!response.data || response.data.length === 0) {
                    hideSystemLoadingState();
                    showError('æœªæ‰¾åˆ°è‚¡ç¥¨æ•°æ®');
                    return;
                }

                stockData = response.data;
                
                // æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡éƒ¨åˆ†
                renderSystemIndicators();
                
                // ç³»ç»ŸæŒ‡æ ‡åŠ è½½å®Œæˆåï¼Œå¼‚æ­¥å¯åŠ¨AIåˆ†æ
                startAIAnalysis();
            },
            error: function(xhr, status, error) {
                hideSystemLoadingState();
                
                let errorMsg = 'è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (error) {
                    errorMsg += ': ' + error;
                }
                showError(errorMsg);
            }
        });
    }
    
    // é‡ç½®UIçŠ¶æ€
    function resetUI() {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        processingTime = 0;
        
        // éšè—é”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').hide();
        
        // é‡ç½®AIåˆ†æåŒºåŸŸ
        $('#ai-analysis-status').text('å‡†å¤‡åˆ†æ...').removeClass('bg-success bg-danger').addClass('bg-info');
        $('#ai-analysis-content').css('opacity', '0');
        $('#ai-analysis-loader').show();
        $('#ai-progress-bar').css('width', '0%');
        $('#ai-processing-time').text('0');
    }
    
    // æ˜¾ç¤ºç³»ç»ŸæŒ‡æ ‡åŠ è½½çŠ¶æ€
    function showSystemLoadingState() {
        // å·²é€šè¿‡é—ªçƒæ•ˆæœå±•ç¤º
    }
    
    // éšè—ç³»ç»ŸæŒ‡æ ‡åŠ è½½çŠ¶æ€
    function hideSystemLoadingState() {
        // é—ªçƒæ•ˆæœä¼šåœ¨æ¸²æŸ“å®é™…å†…å®¹æ—¶è¢«æ›¿æ¢
    }
    
    // æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡éƒ¨åˆ†
    function renderSystemIndicators() {
        try {
            if (!stockData || stockData.length === 0) {
                showError("æ— å¯ç”¨æ•°æ®");
                return;
            }
            
            const latestData = stockData[stockData.length - 1];
            const prevData = stockData.length > 1 ? stockData[stockData.length - 2] : latestData;
            
            // è®¾ç½®æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯
            updateStockInfo(latestData);
            
            // æ¸²æŸ“ä»·æ ¼å›¾è¡¨
            renderPriceChart();
            
            // æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨
            renderIndicatorsChart();
            
            // æ¸²æŸ“æˆäº¤é‡å›¾è¡¨
            renderVolumeChart();
            
            // è·å–æˆ–è®¡ç®—æ”¯æ’‘å‹åŠ›ä½
            calculateAndRenderSupportResistance(latestData);
            
            // è°ƒç”¨åç«¯APIè·å–ç»Ÿä¸€è¯„åˆ†
            fetchAndRenderScore();
            
            // éšè—åŠ è½½çŠ¶æ€
            hideSystemLoadingState();
        } catch (error) {
            console.error("æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡æ—¶å‡ºé”™:", error);
            showError("æ¸²æŸ“ç³»ç»ŸæŒ‡æ ‡æ—¶å‡ºé”™: " + error.message);
        }
    }

    // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
    function safeGet(obj, path, defaultValue) {
        if (!obj) return defaultValue;
        
        const props = path.split('.');
        let current = obj;
        
        for (let i = 0; i < props.length; i++) {
            if (current === undefined || current === null) {
                console.warn(`å±æ€§è·¯å¾„ ${path} åœ¨ ${props.slice(0, i).join('.')} å¤„ä¸­æ–­`);
                return defaultValue;
            }
            current = current[props[i]];
        }
        
        return current !== undefined && current !== null ? current : defaultValue;
    }
    
    // æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
    function updateStockInfo(latestData) {

        console.info('æ•°æ®é›†ğŸ“š:', latestData);

        // è·å–æœ€æ–°ä»·æ ¼å’Œæ¶¨è·Œ
        const currentPrice = parseFloat(latestData.close);
        const previousPrice = stockData.length > 1 ? parseFloat(stockData[stockData.length - 2].close) : currentPrice;
        const priceChange = currentPrice - previousPrice;
        const priceChangePercent = (priceChange / previousPrice) * 100;

        // å°è¯•ä»å¤šä¸ªæ¥æºè·å–è‚¡ç¥¨åç§°
        let stockName = "åŠ è½½ä¸­...";
        let industry = "è¡Œä¸šæ•°æ®åŠ è½½ä¸­...";

        // è°ƒè¯•ï¼šæ£€æŸ¥latestDataä¸­çš„å­—æ®µ
        console.log('latestDataå­—æ®µ:', Object.keys(latestData));
        console.log('latestData.stockName:', latestData.stockName);
        console.log('latestData.stock_name:', latestData.stock_name);

        // 1. é¦–å…ˆå°è¯•ä»latestDataè·å–è‚¡ç¥¨åç§°
        if (latestData.stockName && latestData.stockName !== "æœªçŸ¥") {
            stockName = latestData.stockName;
            console.log('ä½¿ç”¨latestData.stockName:', stockName);

            // è®¾ç½®é¡µé¢ä¸­çš„è‚¡ç¥¨ä»£ç å’Œåç§°
            $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
            $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${new Date(latestData.date).toLocaleDateString()}`);
        } else if (latestData.stock_name && latestData.stock_name !== "æœªçŸ¥") {
            stockName = latestData.stock_name;
            console.log('ä½¿ç”¨latestData.stock_name:', stockName);

            // è®¾ç½®é¡µé¢ä¸­çš„è‚¡ç¥¨ä»£ç å’Œåç§°
            $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
            $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${new Date(latestData.date).toLocaleDateString()}`);
        } else {
            // 2. å¦‚æœæ²¡æœ‰è‚¡ç¥¨åç§°ï¼Œç«‹å³å‘èµ·APIè¯·æ±‚è·å–åŸºæœ¬ä¿¡æ¯
            console.log('latestDataä¸­æ²¡æœ‰æœ‰æ•ˆçš„è‚¡ç¥¨åç§°ï¼Œè°ƒç”¨fetchStockBasicInfo');

            // å…ˆè®¾ç½®ä¸´æ—¶çš„åŠ è½½çŠ¶æ€
            $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
            $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${new Date(latestData.date).toLocaleDateString()}`);

            // ç„¶åå¼‚æ­¥è·å–è‚¡ç¥¨åç§°
            fetchStockBasicInfo(stockCode, marketType);
        }
        // æ ¹æ®å¸‚åœºç±»å‹æ˜¾ç¤ºä¸åŒæ ‡ç­¾
        let marketBadge = '';
        if (marketType === 'A') {
            marketBadge = '<span class="badge bg-primary">Aè‚¡</span>';
        } else if (marketType === 'HK') {
            marketBadge = '<span class="badge bg-success">æ¸¯è‚¡</span>';
        } else if (marketType === 'US') {
            marketBadge = '<span class="badge bg-info">ç¾è‚¡</span>';
        }
        $('#market-badge').html(marketBadge);
        
        // æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
        // const industry = latestData.industry || "æœªçŸ¥è¡Œä¸š";
        const date = new Date(latestData.date).toLocaleDateString();
        // $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${date}`);
        
        // æ›´æ–°ä»·æ ¼
        const priceChangeClass = priceChange >= 0 ? 'trend-up' : 'trend-down';
        const priceChangeIcon = priceChange >= 0 ? '<i class="fas fa-caret-up"></i>' : '<i class="fas fa-caret-down"></i>';
        const priceChangeDisplay = `${priceChangeIcon} ${Math.abs(priceChange).toFixed(2)} (${Math.abs(priceChangePercent).toFixed(2)}%)`;
        
        $('#price-container').html(`
            <div class="stock-price ${priceChangeClass}">${currentPrice.toFixed(2)}</div>
            <div class="price-change ${priceChangeClass}">${priceChangeDisplay}</div>
        `);
        
        // æ›´æ–°å¼€ç›˜ã€æœ€é«˜ã€æœ€ä½ä»·æ ¼ï¼Œå¹¶æ¸…é™¤shimmer-skeletonæ ·å¼
        $('#open-price')
            .removeClass('shimmer-skeleton')
            .removeAttr('style')
            .text(latestData.open ? parseFloat(latestData.open).toFixed(2) : '--')
            .css({
                'color': 'var(--md-sys-color-on-primary-container)',
                'font-size': '16px',
                'font-weight': '500'
            });

        $('#high-price')
            .removeClass('shimmer-skeleton')
            .removeAttr('style')
            .text(latestData.high ? parseFloat(latestData.high).toFixed(2) : '--')
            .css({
                'color': 'var(--md-sys-color-on-primary-container)',
                'font-size': '16px',
                'font-weight': '500'
            });

        $('#low-price')
            .removeClass('shimmer-skeleton')
            .removeAttr('style')
            .text(latestData.low ? parseFloat(latestData.low).toFixed(2) : '--')
            .css({
                'color': 'var(--md-sys-color-on-primary-container)',
                'font-size': '16px',
                'font-weight': '500'
            });

        // æ›´æ–°æˆäº¤é‡ä¿¡æ¯ï¼Œå¹¶æ¸…é™¤shimmer-skeletonæ ·å¼
        const volume = latestData.volume;
        let volumeText = '--';
        if (volume && volume > 0) {
            if (volume >= 100000000) {
                volumeText = (volume / 100000000).toFixed(2) + 'äº¿';
            } else if (volume >= 10000) {
                volumeText = (volume / 10000).toFixed(2) + 'ä¸‡';
            } else {
                volumeText = volume.toFixed(0);
            }
        }
        $('#volume-info')
            .removeClass('shimmer-skeleton')
            .removeAttr('style')
            .text(volumeText)
            .css({
                'color': 'var(--md-sys-color-on-primary-container)',
                'font-size': '16px',
                'font-weight': '500'
            });

        // æ›´æ–°AIåˆ†æè‚¡ç¥¨åç§°
        $('#ai-analysis-stock-name').text(stockName);
    }

    // å¸¸è§è‚¡ç¥¨ä»£ç åˆ°åç§°çš„æ˜ å°„è¡¨
    const stockNameMap = {
        '000001': 'å¹³å®‰é“¶è¡Œ',
        '000002': 'ä¸‡ç§‘A',
        '000858': 'äº”ç²®æ¶²',
        '000725': 'äº¬ä¸œæ–¹A',
        '600519': 'è´µå·èŒ…å°',
        '600036': 'æ‹›å•†é“¶è¡Œ',
        '000858': 'äº”ç²®æ¶²',
        '002415': 'æµ·åº·å¨è§†',
        '600276': 'æ’ç‘åŒ»è¯',
        '000063': 'ä¸­å…´é€šè®¯',
        '002594': 'æ¯”äºšè¿ª',
        '600887': 'ä¼Šåˆ©è‚¡ä»½',
        '000166': 'ç”³ä¸‡å®æº',
        '600031': 'ä¸‰ä¸€é‡å·¥',
        '002304': 'æ´‹æ²³è‚¡ä»½',
        '600900': 'é•¿æ±Ÿç”µåŠ›',
        '000568': 'æ³¸å·è€çª–',
        '002142': 'å®æ³¢é“¶è¡Œ',
        '600585': 'æµ·èºæ°´æ³¥',
        '000338': 'æ½æŸ´åŠ¨åŠ›'
    };

    // è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯çš„å‡½æ•°
    function fetchStockBasicInfo(stockCode, marketType) {
        // é¦–å…ˆå°è¯•ä»æœ¬åœ°æ˜ å°„è¡¨è·å–è‚¡ç¥¨åç§°
        const localStockName = stockNameMap[stockCode];
        if (localStockName) {
            const stockName = localStockName;
            const industry = "æœªçŸ¥è¡Œä¸š";

            // è°ƒè¯•ï¼šæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            console.log('æ£€æŸ¥#stock-titleå…ƒç´ :', $('#stock-title').length);
            console.log('å½“å‰#stock-titleå†…å®¹:', $('#stock-title').html());

            // æ›´æ–°è‚¡ç¥¨æ ‡é¢˜ - ä½¿ç”¨å®Œæ•´çš„HTMLç»“æ„
            $('#stock-title').html(`
                <h1 style="font-size: 28px; font-weight: 600; margin: 0; color: var(--md-sys-color-on-surface); line-height: 1.2;">
                    ${stockName} <span style="color: var(--md-sys-color-outline); font-size: 20px; font-weight: 400;">${stockCode}</span>
                </h1>
                <div style="color: var(--md-sys-color-outline); font-size: 14px; margin-top: 4px;">
                    ${industry} | æ•°æ®æ—¥æœŸ: ${new Date().toLocaleDateString()}
                </div>
            `);

            // è°ƒè¯•ï¼šæ£€æŸ¥æ›´æ–°åçš„å†…å®¹
            console.log('æ›´æ–°å#stock-titleå†…å®¹:', $('#stock-title').html());

            // æ›´æ–°AIåˆ†æåŒºåŸŸçš„è‚¡ç¥¨åç§°
            $('#ai-analysis-stock-name').text(stockName);

            console.log(`ä½¿ç”¨æœ¬åœ°æ˜ å°„è·å–è‚¡ç¥¨åç§°: ${stockName}`);
            return;
        }

        // å¦‚æœæœ¬åœ°æ˜ å°„è¡¨æ²¡æœ‰ï¼Œå†å°è¯•APIè°ƒç”¨
        $.ajax({
            url: '/api/stock_basic_info',
            method: 'GET',
            data: {
                stock_code: stockCode,
                market_type: marketType || 'A'
            },
            success: function(response) {
                if (response && response.stock_name) {
                    // æ›´æ–°è‚¡ç¥¨åç§°
                    const stockName = response.stock_name;
                    const industry = response.industry || "æœªçŸ¥è¡Œä¸š";

                    // æ›´æ–°è‚¡ç¥¨æ ‡é¢˜ - ä½¿ç”¨å®Œæ•´çš„HTMLç»“æ„
                    $('#stock-title').html(`
                        <h1 style="font-size: 28px; font-weight: 600; margin: 0; color: var(--md-sys-color-on-surface); line-height: 1.2;">
                            ${stockName} <span style="color: var(--md-sys-color-outline); font-size: 20px; font-weight: 400;">${stockCode}</span>
                        </h1>
                        <div style="color: var(--md-sys-color-outline); font-size: 14px; margin-top: 4px;">
                            ${industry} | æ•°æ®æ—¥æœŸ: ${new Date().toLocaleDateString()}
                        </div>
                    `);

                    // æ›´æ–°AIåˆ†æåŒºåŸŸçš„è‚¡ç¥¨åç§°
                    $('#ai-analysis-stock-name').text(stockName);

                    console.log(`æˆåŠŸè·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯: ${stockName} (${industry})`);
                } else {
                    console.warn('è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å“åº”æ ¼å¼å¼‚å¸¸:', response);
                    // ä½¿ç”¨å¤‡ç”¨åç§°
                    useFallbackStockName(stockCode);
                }
            },
            error: function(xhr, status, error) {
                console.error('è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å¤±è´¥:', error);
                // ä½¿ç”¨å¤‡ç”¨åç§°
                useFallbackStockName(stockCode);
            }
        });
    }

    // ä½¿ç”¨å¤‡ç”¨è‚¡ç¥¨åç§°çš„å‡½æ•°
    function useFallbackStockName(stockCode) {
        let fallbackName;

        // æ ¹æ®è‚¡ç¥¨ä»£ç å‰ç¼€åˆ¤æ–­å¸‚åœºå’Œç”Ÿæˆåˆé€‚çš„åç§°
        if (stockCode.startsWith('00')) {
            fallbackName = `æ·±å¸‚è‚¡ç¥¨${stockCode}`;
        } else if (stockCode.startsWith('60')) {
            fallbackName = `æ²ªå¸‚è‚¡ç¥¨${stockCode}`;
        } else if (stockCode.startsWith('30')) {
            fallbackName = `åˆ›ä¸šæ¿${stockCode}`;
        } else {
            fallbackName = `è‚¡ç¥¨${stockCode}`;
        }

        // æ›´æ–°è‚¡ç¥¨æ ‡é¢˜ - ä½¿ç”¨å®Œæ•´çš„HTMLç»“æ„
        $('#stock-title').html(`
            <h1 style="font-size: 28px; font-weight: 600; margin: 0; color: var(--md-sys-color-on-surface); line-height: 1.2;">
                ${fallbackName} <span style="color: var(--md-sys-color-outline); font-size: 20px; font-weight: 400;">${stockCode}</span>
            </h1>
            <div style="color: var(--md-sys-color-outline); font-size: 14px; margin-top: 4px;">
                æœªçŸ¥è¡Œä¸š | æ•°æ®æ—¥æœŸ: ${new Date().toLocaleDateString()}
            </div>
        `);

        // æ›´æ–°AIåˆ†æåŒºåŸŸçš„è‚¡ç¥¨åç§°
        $('#ai-analysis-stock-name').text(fallbackName);

        console.log(`ä½¿ç”¨å¤‡ç”¨åç§°: ${fallbackName}`);
    }
    
    // ä»åç«¯APIè·å–ç»Ÿä¸€è¯„åˆ†å¹¶æ¸²æŸ“
    function fetchAndRenderScore() {
        console.log(`å¼€å§‹è·å–è‚¡ç¥¨ ${stockCode} çš„ç»Ÿä¸€è¯„åˆ†`);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $('#score-container').html(`
            <div class="score-indicator">
                <div class="score-loading">
                    <div class="shimmer-skeleton" style="width: 160px; height: 160px; border-radius: 50%;"></div>
                    <div class="score-display">
                        <div class="shimmer-skeleton" style="width: 60px; height: 48px; margin: 0 auto 8px;"></div>
                        <div class="shimmer-skeleton" style="width: 80px; height: 16px; margin: 0 auto;"></div>
                    </div>
                </div>
            </div>
        `);

        $('#recommendation-container').html(`
            <div class="shimmer-skeleton" style="width: 120px; height: 32px; margin: 0 auto;"></div>
        `);

        // è°ƒç”¨åç«¯ç»Ÿä¸€è¯„åˆ†API
        $.ajax({
            url: '/api/stock_score',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stock_code: stockCode,
                market_type: marketType
            }),
            timeout: 15000, // 15ç§’è¶…æ—¶
            success: function(response) {
                console.log('è·å–è¯„åˆ†æˆåŠŸ:', response);

                const score = response.score || 0;
                const scoreDetails = response.score_details || {};
                const recommendation = response.recommendation || 'æ— å»ºè®®';

                // æ¸²æŸ“è¯„åˆ†
                const scoreClass = getScoreColorClass(score);
                const scoreText = getScoreDescription(score);

                $('#score-container').html(`
                    <div class="score-indicator">
                        <div id="score-chart"></div>
                        <div class="score-display">
                            <p class="score-value">${score}</p>
                            <p class="score-label">ç»¼åˆè¯„åˆ†</p>
                        </div>
                    </div>
                `);

                // æ¸²æŸ“ç¯å½¢å›¾è¡¨
                renderScoreChart(score);

                // æ¸²æŸ“å»ºè®®
                $('#recommendation-container').html(`
                    <div class="badge badge-pill ${scoreClass} px-3 py-2">${scoreText}</div>
                `);

                // æ˜¾ç¤ºè¯„åˆ†æ˜ç»†æŒ‰é’®
                $('#score-details-toggle').show();

                // æ¸²æŸ“è¯„åˆ†æ˜ç»†
                const scoreBreakdown = response.score_breakdown || {};
                renderScoreDetails(scoreDetails, score, scoreBreakdown);

                console.log(`è‚¡ç¥¨ ${stockCode} è¯„åˆ†æ¸²æŸ“å®Œæˆ: ${score}`);

                // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†ä»stockDataè·å–ï¼‰
                if (stockData && stockData.length > 0) {
                    renderTechnicalIndicators(stockData[stockData.length - 1]);
                }
            },
            error: function(xhr, status, error) {
                console.error('è·å–è¯„åˆ†å¤±è´¥:', error);

                let errorMsg = 'è·å–è¯„åˆ†å¤±è´¥';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (error) {
                    errorMsg += ': ' + error;
                }

                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                $('#score-container').html(`
                    <div class="score-indicator">
                        <div class="score-error">
                            <i class="material-icons" style="font-size: 48px; color: #f44336;">error</i>
                            <div class="score-display">
                                <p class="score-value">--</p>
                                <p class="score-label">è¯„åˆ†è·å–å¤±è´¥</p>
                            </div>
                        </div>
                    </div>
                `);

                $('#recommendation-container').html(`
                    <div class="badge badge-pill badge-secondary px-3 py-2">è¯„åˆ†è·å–å¤±è´¥</div>
                `);

                // æ˜¾ç¤ºé”™è¯¯æç¤º
                showError(errorMsg);

                // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†ä»stockDataè·å–ï¼‰
                if (stockData && stockData.length > 0) {
                    renderTechnicalIndicators(stockData[stockData.length - 1]);
                }
            }
        });
    }

    // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡ï¼ˆä»åŸå‡½æ•°ä¸­åˆ†ç¦»å‡ºæ¥ï¼‰
    function renderTechnicalIndicators(latestData) {
        const rsi = parseFloat(latestData.RSI || 50);
        const ma5 = parseFloat(latestData.MA5 || 0);
        const ma20 = parseFloat(latestData.MA20 || 0);
        const ma60 = parseFloat(latestData.MA60 || 0);
        const macd = parseFloat(latestData.MACD || 0);
        const signal = parseFloat(latestData.Signal || 0);
        const volRatio = parseFloat(latestData.Volume_Ratio || 1);

        // æ¸²æŸ“å…³é”®æŒ‡æ ‡
        $('#rsi-container').html(`
            <div class="stat-value">${rsi.toFixed(1)}</div>
            <div class="stat-label">RSI</div>
        `);

        const maTrend = ma5 > ma20 ? 'trend-up' : 'trend-down';
        const maTrendIcon = ma5 > ma20 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

        $('#ma-trend-container').html(`
            <div class="stat-value ${maTrend}">${maTrendIcon}</div>
            <div class="stat-label">å‡çº¿è¶‹åŠ¿</div>
        `);

        const macdTrend = macd > signal ? 'trend-up' : 'trend-down';
        const macdTrendIcon = macd > signal ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

        $('#macd-container').html(`
            <div class="stat-value ${macdTrend}">${macdTrendIcon}</div>
            <div class="stat-label">MACD</div>
        `);

        const volumeStatus = volRatio > 1 ? 'trend-up' : 'trend-down';
        const volumeIcon = volRatio > 1 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

        $('#volume-container').html(`
            <div class="stat-value ${volumeStatus}">${volRatio.toFixed(1)}</div>
            <div class="stat-label">é‡æ¯”</div>
        `);

        // è®¡ç®—æˆäº¤é‡è¶‹åŠ¿æŒ‡æ ‡
        const currentVolume = parseFloat(latestData.volume || 0);
        const avgVolume = parseFloat(latestData.Volume_MA || currentVolume);
        const volumeTrendRatio = avgVolume > 0 ? (currentVolume / avgVolume) : 1;
        const volumeTrendStatus = volumeTrendRatio > 1 ? 'trend-up' : 'trend-down';
        const volumeTrendIcon = volumeTrendRatio > 1 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';

        $('#volume-trend-container').html(`
            <div class="stat-value ${volumeTrendStatus}">${volumeTrendIcon}</div>
            <div class="stat-label">æˆäº¤é‡è¶‹åŠ¿</div>
        `);

        // æ¸²æŸ“é›·è¾¾å›¾
        renderRadarChart(rsi/10, (ma5 > ma20 ? 8 : 3), (macd > signal ? 8 : 3), (volRatio > 1 ? 8 : 3));
    }
    
    // è®¡ç®—å¹¶æ¸²æŸ“æ”¯æ’‘å‹åŠ›ä½
    function calculateAndRenderSupportResistance(latestData) {
        const currentPrice = parseFloat(latestData.close);
        
        // å¸ƒæ—å¸¦æ”¯æ’‘å‹åŠ›
        const upperBand = parseFloat(latestData.BB_upper || (currentPrice * 1.05));
        const lowerBand = parseFloat(latestData.BB_lower || (currentPrice * 0.95));
        
        // ç§»åŠ¨å¹³å‡çº¿æ”¯æ’‘å‹åŠ›
        const ma5 = parseFloat(latestData.MA5 || 0);
        const ma20 = parseFloat(latestData.MA20 || 0);
        const ma60 = parseFloat(latestData.MA60 || 0);
        
        // è®¡ç®—æ”¯æ’‘ä½
        const supports = [];
        const resistances = [];
        
        // å¦‚æœä»·æ ¼åœ¨å‡çº¿ä¸Šæ–¹ï¼Œå°†å‡çº¿ä½œä¸ºæ”¯æ’‘ä½
        if (currentPrice > ma5) supports.push({level: ma5, type: 'MA5', distance: ((ma5 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma5, type: 'MA5', distance: ((ma5 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        if (currentPrice > ma20) supports.push({level: ma20, type: 'MA20', distance: ((ma20 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma20, type: 'MA20', distance: ((ma20 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        if (currentPrice > ma60) supports.push({level: ma60, type: 'MA60', distance: ((ma60 - currentPrice) / currentPrice * 100).toFixed(2)});
        else resistances.push({level: ma60, type: 'MA60', distance: ((ma60 - currentPrice) / currentPrice * 100).toFixed(2)});
        
        // å¸ƒæ—å¸¦æ”¯æ’‘å‹åŠ›
        supports.push({level: lowerBand, type: 'å¸ƒæ—ä¸‹è½¨', distance: ((lowerBand - currentPrice) / currentPrice * 100).toFixed(2)});
        resistances.push({level: upperBand, type: 'å¸ƒæ—ä¸Šè½¨', distance: ((upperBand - currentPrice) / currentPrice * 100).toFixed(2)});
        
        // æ·»åŠ æ•´æ•°å…³å£
        const integerSupport = Math.floor(currentPrice);
        const integerResistance = Math.ceil(currentPrice);
        
        if (integerSupport < currentPrice) {
            supports.push({level: integerSupport, type: 'æ•´æ•°å…³å£', distance: ((integerSupport - currentPrice) / currentPrice * 100).toFixed(2)});
        }
        
        if (integerResistance > currentPrice) {
            resistances.push({level: integerResistance, type: 'æ•´æ•°å…³å£', distance: ((integerResistance - currentPrice) / currentPrice * 100).toFixed(2)});
        }
        
        // æŒ‰è·ç¦»æ’åº
        supports.sort((a, b) => parseFloat(b.distance) - parseFloat(a.distance));
        resistances.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
        
        // æ¸²æŸ“è¡¨æ ¼
        let tableHtml = `
            <table class="table table-sm support-resistance-table">
                <thead>
                    <tr>
                        <th>ç±»å‹</th>
                        <th>ä»·æ ¼</th>
                        <th>è·ç¦»</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // æ·»åŠ å‹åŠ›ä½
        resistances.slice(0, 3).forEach(r => {
            tableHtml += `
                <tr>
                    <td><span class="badge bg-danger">å‹åŠ›</span> ${r.type}</td>
                    <td>${r.level.toFixed(2)}</td>
                    <td>+${Math.abs(r.distance)}%</td>
                </tr>
            `;
        });
        
        // æ·»åŠ å½“å‰ä»·æ ¼
        tableHtml += `
            <tr class="table-info">
                <td><span class="badge bg-primary">å½“å‰</span></td>
                <td>${currentPrice.toFixed(2)}</td>
                <td>-</td>
            </tr>
        `;
        
        // æ·»åŠ æ”¯æ’‘ä½
        supports.slice(0, 3).forEach(s => {
            tableHtml += `
                <tr>
                    <td><span class="badge bg-success">æ”¯æ’‘</span> ${s.type}</td>
                    <td>${s.level.toFixed(2)}</td>
                    <td>${s.distance}%</td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        $('#support-resistance-container').html(tableHtml);
    }
    
    // æ¸²æŸ“è¯„åˆ†å›¾è¡¨
    function renderScoreChart(score) {
        const options = {
            series: [score],
            chart: {
                height: 180,
                type: 'radialBar',
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                radialBar: {
                    startAngle: -135,
                    endAngle: 135,
                    hollow: {
                        margin: 0,
                        size: '70%',
                    },
                    dataLabels: {
                        show: false
                    },
                    track: {
                        background: '#f2f2f2',
                        strokeWidth: '97%',
                        margin: 5,
                        dropShadow: {
                            enabled: false
                        }
                    }
                }
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shade: 'dark',
                    type: 'horizontal',
                    shadeIntensity: 0.5,
                    gradientToColors: [getScoreGradientColor(score)],
                    inverseColors: true,
                    opacityFrom: 1,
                    opacityTo: 1,
                    stops: [0, 100]
                }
            },
            stroke: {
                lineCap: 'round'
            },
            colors: [getScoreColor(score)]
        };

        const chart = new ApexCharts(document.querySelector("#score-chart"), options);
        chart.render();
    }
    
    // æ¸²æŸ“é›·è¾¾å›¾
    function renderRadarChart(rsiScore, trendScore, macdScore, volumeScore) {
        $('#radar-chart-container').html('<div id="radar-chart" style="height: 200px;"></div>');
        
        const options = {
            series: [{
                name: 'è¯„åˆ†',
                data: [rsiScore, trendScore, macdScore, volumeScore]
            }],
            chart: {
                height: 200,
                type: 'radar',
                toolbar: {
                    show: false
                },
                dropShadow: {
                    enabled: true,
                    blur: 1,
                    left: 1,
                    top: 1
                }
            },
            stroke: {
                width: 2
            },
            fill: {
                opacity: 0.2
            },
            markers: {
                size: 3
            },
            xaxis: {
                categories: ['RSI', 'è¶‹åŠ¿', 'MACD', 'æˆäº¤é‡']
            },
            yaxis: {
                show: false,
                min: 0,
                max: 10
            },
            plotOptions: {
                radar: {
                    polygons: {
                        strokeColors: '#e9e9e9',
                        fill: {
                            colors: ['#f8f8f8', '#fff']
                        }
                    }
                }
            }
        };

        const chart = new ApexCharts(document.querySelector("#radar-chart"), options);
        chart.render();
    }
    
    // æ¸²æŸ“ä»·æ ¼å›¾è¡¨
    function renderPriceChart() {
        $('#price-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const closePrices = stockData.map(item => ({
                x: new Date(item.date),
                y: parseFloat(item.close || 0)
            }));
            
            const ma5Data = stockData.map(item => ({
                x: new Date(item.date),
                y: item.MA5 ? parseFloat(item.MA5) : null
            }));

            const ma20Data = stockData.map(item => ({
                x: new Date(item.date),
                y: item.MA20 ? parseFloat(item.MA20) : null
            }));

            const ma60Data = stockData.map(item => ({
                x: new Date(item.date),
                y: item.MA60 ? parseFloat(item.MA60) : null
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: closePrices
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma5Data
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma20Data
                    },
                    {
                        name: 'MA60',
                        type: 'line',
                        data: ma60Data
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    }
                },
                stroke: {
                    width: [3, 2, 2, 2],
                    curve: 'smooth',
                    dashArray: [0, 0, 0, 0]
                },
                colors: ['#4e73df', '#36b9cc', '#1cc88a', '#f6c23e'],
                fill: {
                    type: 'solid',
                    opacity: [1, 0.8, 0.8, 0.8],
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (value) {
                            return value.toFixed(2);
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value) {
                            return value ? value.toFixed(2) : '-';
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                },
                grid: {
                    borderColor: '#e0e0e0',
                    strokeDashArray: 5,
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#price-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“ä»·æ ¼å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#price-chart').html('<div class="alert alert-danger">ä»·æ ¼å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
    function renderIndicatorsChart() {
        $('#indicators-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const macdData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.MACD ? parseFloat(item.MACD) : 0
            }));

            const signalData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.Signal ? parseFloat(item.Signal) : 0
            }));

            const histogramData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.MACD_hist ? parseFloat(item.MACD_hist) : 0
            }));

            const rsiData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.RSI ? parseFloat(item.RSI) : 50
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'MACD',
                        type: 'line',
                        data: macdData
                    },
                    {
                        name: 'Signal',
                        type: 'line',
                        data: signalData
                    },
                    {
                        name: 'Histogram',
                        type: 'bar',
                        data: histogramData
                    },
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsiData
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    width: [3, 3, 0, 3],
                    curve: 'smooth'
                },
                colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                plotOptions: {
                    bar: {
                        columnWidth: '80%'
                    }
                },
                fill: {
                    opacity: [1, 1, 0.8, 1]
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: 'MACD'
                        },
                        labels: {
                            formatter: function (value) {
                                return value.toFixed(3);
                            }
                        }
                    },
                    {
                        show: false,
                        seriesName: 'Signal'
                    },
                    {
                        show: false,
                        seriesName: 'Histogram'
                    },
                    {
                        opposite: true,
                        title: {
                            text: 'RSI'
                        },
                        min: 0,
                        max: 100,
                        seriesName: 'RSI',
                        labels: {
                            formatter: function (value) {
                                return value.toFixed(1);
                            }
                        }
                    }
                ],
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value, { seriesIndex }) {
                            if (seriesIndex === 0 || seriesIndex === 1 || seriesIndex === 2) {
                                return value.toFixed(3);
                            }
                            return value.toFixed(1);
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector("#indicators-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#indicators-chart').html('<div class="alert alert-danger">æŒ‡æ ‡å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // æ¸²æŸ“æˆäº¤é‡å›¾è¡¨
    function renderVolumeChart() {
        $('#volume-chart').empty();
        
        try {
            // å‡†å¤‡æ•°æ®
            const volumeData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.volume ? parseFloat(item.volume) : 0
            }));

            const volMaData = stockData.map(item => ({
                x: new Date(item.date),
                y: item.Volume_MA ? parseFloat(item.Volume_MA) : 0
            }));
            
            // åˆ›å»ºå›¾è¡¨é…ç½®
            const options = {
                series: [
                    {
                        name: 'æˆäº¤é‡',
                        type: 'bar',
                        data: volumeData
                    },
                    {
                        name: 'å‡é‡çº¿',
                        type: 'line',
                        data: volMaData
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    animations: {
                        enabled: false
                    },
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    width: [0, 3],
                    curve: 'smooth'
                },
                colors: ['#4e73df', '#1cc88a'],
                fill: {
                    opacity: [0.8, 1]
                },
                plotOptions: {
                    bar: {
                        columnWidth: '80%'
                    }
                },
                markers: {
                    size: 0
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString();
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (value) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(1) + 'K';
                            }
                            return value;
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (value, { seriesIndex }) {
                            if (value >= 1000000) {
                                return (value / 1000000).toFixed(2) + ' ç™¾ä¸‡';
                            } else if (value >= 1000) {
                                return (value / 1000).toFixed(2) + ' åƒ';
                            }
                            return value;
                        }
                    },
                    x: {
                        format: 'yyyy-MM-dd'
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                }
            };

            const chart = new ApexCharts(document.querySelector("#volume-chart"), options);
            chart.render();
        } catch (error) {
            console.error("æ¸²æŸ“æˆäº¤é‡å›¾è¡¨æ—¶å‡ºé”™:", error);
            $('#volume-chart').html('<div class="alert alert-danger">æˆäº¤é‡å›¾è¡¨æ¸²æŸ“å¤±è´¥</div>');
        }
    }
    
    // å¯åŠ¨AIåˆ†æ
    function startAIAnalysis() {
        console.log(`å¼€å§‹å¯åŠ¨AIåˆ†æï¼Œè‚¡ç¥¨ä»£ç : ${stockCode}, å¸‚åœºç±»å‹: ${marketType}`);

        resetAIAnalysisUI();

        // å¯åŠ¨å¤„ç†æ—¶é—´è®¡æ—¶å™¨
        processingTime = 0;
        processingTimer = setInterval(function() {
            processingTime++;
            $('#ai-processing-time').text(processingTime);

            // æ›´æ–°è¿›åº¦æ¡ - åˆ›å»ºä¸€ä¸ªå‡çš„è¿›åº¦
            const progressPercent = Math.min(95, processingTime / 2);
            $('#ai-progress-bar').css('width', progressPercent + '%');
        }, 1000);

        // å¯åŠ¨AIåˆ†æä»»åŠ¡
        $.ajax({
            url: '/api/start_stock_analysis',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stock_code: stockCode,
                market_type: marketType
            }),
            timeout: 30000, // 30ç§’è¶…æ—¶
            success: function(response) {
                console.log('AIåˆ†æä»»åŠ¡å¯åŠ¨å“åº”:', response);

                // éªŒè¯å“åº”æ ¼å¼
                if (!response || typeof response !== 'object') {
                    console.error('æ— æ•ˆçš„å“åº”æ ¼å¼:', response);
                    handleAIAnalysisError(null, 'invalid_response', 'æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æœ
                if (response.status === 'completed' && response.result) {
                    console.log('ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥å¤„ç†ç»“æœ');
                    // ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥å¤„ç†ç»“æœ
                    handleAIAnalysisResult(response.result);
                    return;
                }

                // éªŒè¯ä»»åŠ¡ID
                if (!response.task_id || typeof response.task_id !== 'string') {
                    console.error('æ— æ•ˆçš„ä»»åŠ¡ID:', response.task_id);
                    handleAIAnalysisError(null, 'invalid_task_id', 'æœåŠ¡å™¨è¿”å›æ— æ•ˆçš„ä»»åŠ¡ID');
                    return;
                }

                console.log(`ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID: ${response.task_id}`);

                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                pollAIAnalysisStatus(response.task_id);
            },
            error: function(xhr, status, error) {
                console.error('å¯åŠ¨AIåˆ†æå¤±è´¥:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    error: error
                });
                handleAIAnalysisError(xhr, status, error);
            }
        });
    }
    
    // è½®è¯¢AIåˆ†æçŠ¶æ€ - ä¼˜åŒ–ç‰ˆæœ¬
    function pollAIAnalysisStatus(taskId) {
        // éªŒè¯ä»»åŠ¡ID
        if (!taskId || typeof taskId !== 'string') {
            console.error('æ— æ•ˆçš„ä»»åŠ¡ID:', taskId);
            handleAIAnalysisError(null, 'invalid_task_id', 'æ— æ•ˆçš„ä»»åŠ¡ID');
            return;
        }

        // æ¸…ç†æ—§çš„è½®è¯¢çŠ¶æ€
        cleanupPollingState();

        // ä¿å­˜å½“å‰ä»»åŠ¡IDï¼Œç”¨äºå–æ¶ˆ
        window.currentAnalysisTaskId = taskId;

        // åˆå§‹åŒ–è½®è¯¢çŠ¶æ€
        window.pollRetryCount = 0;
        window.pollStartTime = Date.now();
        window.maxPollRetries = 10; // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š10æ¬¡
        window.maxPollDuration = 1800000; // æœ€å¤§è½®è¯¢æ—¶é—´ï¼š30åˆ†é’Ÿï¼ˆé€‚åº”é•¿æ—¶é—´ä»»åŠ¡ï¼‰

        console.log(`å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€: ${taskId}`);

        // å›ºå®šè½®è¯¢é—´éš”ï¼š30ç§’
        function getPollingInterval() {
            return 30000; // ç»Ÿä¸€ä½¿ç”¨30ç§’é—´éš”
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢æ˜¾ç¤º
        function updatePollingUI() {
            const elapsed = Math.floor((Date.now() - window.pollStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;

            // æ›´æ–°å¤„ç†æ—¶é—´æ˜¾ç¤º
            $('#ai-processing-time').text(elapsed);

            // æ ¹æ®æ—¶é—´é•¿åº¦æ˜¾ç¤ºä¸åŒçš„æç¤ºå’ŒçŠ¶æ€
            let statusText = 'æ­£åœ¨åˆ†æ...';
            let tipsText = 'æ­£åœ¨åˆ†ææŠ€æœ¯æŒ‡æ ‡å’ŒåŸºæœ¬é¢æ•°æ®...';
            let statusClass = 'md3-badge-info';

            if (elapsed > 300) { // 5åˆ†é’Ÿä»¥ä¸Š
                statusText = `æ·±åº¦åˆ†æä¸­... (${timeStr})`;
                tipsText = 'æ­£åœ¨è¿›è¡Œå¤æ‚çš„é‡åŒ–åˆ†æï¼Œè¯·è€å¿ƒç­‰å¾…...';
                statusClass = 'md3-badge-warning';
            } else if (elapsed > 180) { // 3åˆ†é’Ÿä»¥ä¸Š
                statusText = `æ·±åº¦åˆ†æä¸­... (${timeStr})`;
                tipsText = 'æ­£åœ¨åˆ†æå†å²æ•°æ®å’Œå¸‚åœºè¶‹åŠ¿...';
                statusClass = 'md3-badge-warning';
            } else if (elapsed > 60) { // 1åˆ†é’Ÿä»¥ä¸Š
                statusText = `æ™ºèƒ½åˆ†æä¸­... (${timeStr})`;
                tipsText = 'æ­£åœ¨è®¡ç®—æŠ€æœ¯æŒ‡æ ‡å’Œé£é™©è¯„ä¼°...';
                statusClass = 'md3-badge-info';
            } else if (elapsed > 30) { // 30ç§’ä»¥ä¸Š
                statusText = `åˆ†æä¸­... (${timeStr})`;
                tipsText = 'æ­£åœ¨è·å–æœ€æ–°æ•°æ®å’ŒåŸºæœ¬é¢ä¿¡æ¯...';
                statusClass = 'md3-badge-info';
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            $('#ai-analysis-status')
                .text(statusText)
                .removeClass('md3-badge-info md3-badge-warning md3-badge-error md3-badge-success')
                .addClass(statusClass);

            // æ›´æ–°æç¤ºä¿¡æ¯
            $('#ai-analysis-tips').text(tipsText);
        }

        function checkStatus() {
            // æ£€æŸ¥è½®è¯¢è¶…æ—¶
            const elapsed = Date.now() - window.pollStartTime;
            if (elapsed > window.maxPollDuration) {
                console.error(`è½®è¯¢è¶…æ—¶ï¼Œå·²è¿è¡Œ ${elapsed/1000} ç§’`);
                cleanupPollingState();
                handleAIAnalysisError(null, 'timeout', 'åˆ†æè¶…æ—¶ï¼Œè¯·é‡è¯•');
                return;
            }

            // æ£€æŸ¥é‡è¯•æ¬¡æ•°
            if (window.pollRetryCount >= window.maxPollRetries) {
                console.error(`è½®è¯¢é‡è¯•æ¬¡æ•°è¶…é™: ${window.pollRetryCount}`);
                cleanupPollingState();
                handleAIAnalysisError(null, 'max_retries', 'é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·é‡è¯•');
                return;
            }

            // æ›´æ–°UIæ˜¾ç¤º
            updatePollingUI();

            $.ajax({
                url: `/api/analysis_status/${taskId}`,
                type: 'GET',
                timeout: 15000, // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°15ç§’
                success: function(response) {
                    console.log(`è½®è¯¢å“åº”:`, response);

                    // é‡ç½®é‡è¯•è®¡æ•°
                    window.pollRetryCount = 0;

                    // æ ¹æ®ä»»åŠ¡çŠ¶æ€å¤„ç†
                    if (response.status === 'completed') {
                        // åˆ†æå®Œæˆï¼Œåœæ­¢è½®è¯¢å’Œè®¡æ—¶å™¨
                        console.log('ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢');
                        cleanupPollingState();

                        // å¤„ç†ç»“æœ
                        handleAIAnalysisResult(response.result);
                    } else if (response.status === 'failed') {
                        // åˆ†æå¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                        console.log('ä»»åŠ¡å¤±è´¥ï¼Œåœæ­¢è½®è¯¢');
                        cleanupPollingState();

                        handleAIAnalysisError(null, 'failed', response.error || 'æœªçŸ¥é”™è¯¯');
                    } else {
                        // æ›´æ–°è¿›åº¦
                        const progress = response.progress || 0;
                        $('#ai-progress-bar').css('width', progress + '%');
                        console.log(`ä»»åŠ¡è¿›è¡Œä¸­ï¼Œè¿›åº¦: ${progress}%`);

                        // ç»§ç»­è½®è¯¢ï¼Œä½¿ç”¨åŠ¨æ€é—´éš”
                        const interval = getPollingInterval();
                        console.log(`ä¸‹æ¬¡è½®è¯¢é—´éš”: ${interval}ms`);
                        window.analysisStatusTimeout = setTimeout(checkStatus, interval);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("è½®è¯¢çŠ¶æ€å‡ºé”™:", {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        error: error,
                        taskId: taskId,
                        retryCount: window.pollRetryCount
                    });

                    // ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼šæ‰€æœ‰é”™è¯¯éƒ½ä½¿ç”¨ç›¸åŒçš„é‡è¯•ç­–ç•¥
                    window.pollRetryCount++;
                    console.warn(`è½®è¯¢é”™è¯¯ï¼Œé‡è¯•æ¬¡æ•°: ${window.pollRetryCount}/${window.maxPollRetries}`);

                    if (window.pollRetryCount <= window.maxPollRetries) {
                        // ç»§ç»­é‡è¯•ï¼Œä½¿ç”¨å›ºå®š30ç§’é—´éš”
                        const retryDelay = 30000; // 30ç§’åé‡è¯•
                        console.log(`è½®è¯¢é”™è¯¯é‡è¯•ï¼Œ${retryDelay}msåé‡è¯•`);
                        window.analysisStatusTimeout = setTimeout(checkStatus, retryDelay);
                        return;
                    } else {
                        // é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œä½†ä¸æ¸…ç†çŠ¶æ€ï¼Œç»§ç»­30ç§’åé‡è¯•
                        console.warn('é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œä½†ç»§ç»­ä¿æŒè½®è¯¢çŠ¶æ€');
                        window.pollRetryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°ï¼Œç»§ç»­è½®è¯¢
                        const retryDelay = 30000; // 30ç§’åç»§ç»­
                        console.log(`é‡ç½®é‡è¯•è®¡æ•°ï¼Œ${retryDelay}msåç»§ç»­è½®è¯¢`);
                        window.analysisStatusTimeout = setTimeout(checkStatus, retryDelay);
                        return;
                    }
                }
            });
        }

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        checkStatus();
        console.log('æ™ºèƒ½è½®è¯¢å·²å¯åŠ¨ï¼Œä½¿ç”¨åŠ¨æ€é—´éš”ç­–ç•¥');
    }
    
    // å¤„ç†AIåˆ†æç»“æœ
    function handleAIAnalysisResult(result) {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }
        
        // æ›´æ–°AIåˆ†æçŠ¶æ€
        $('#ai-analysis-status').text('åˆ†æå®Œæˆ').removeClass('bg-info bg-danger').addClass('bg-success');
        
        // æ¸²æŸ“AIåˆ†æå†…å®¹
        const aiAnalysis = result.ai_analysis || 'æ— æ³•è·å–AIåˆ†æç»“æœ';
        $('#ai-analysis').html(formatAIAnalysis(aiAnalysis));
        
        // éšè—åŠ è½½åŠ¨ç”»ï¼Œæ˜¾ç¤ºå†…å®¹
        $('#ai-analysis-loader').fadeOut(300, function() {
            $('#ai-analysis-content').css('opacity', '1');
        });

        // ä»AIåˆ†æç»“æœä¸­æ›´æ–°è‚¡ç¥¨ä¿¡æ¯
        if (result.basic_info) {
            const stockName = result.basic_info.stock_name || $('#stock-title').text().split(' ')[0];
            const industry = result.basic_info.industry || $('#stock-info').text().split(' | ')[0];
            
            $('#stock-title').html(`${stockName} <span class="text-muted">${stockCode}</span>`);
            $('#stock-info').text(`${industry} | æ•°æ®æ—¥æœŸ: ${$('#stock-info').text().split(' | ')[1]}`);
            $('#ai-analysis-stock-name').text(stockName);
        }
}
    
    // å¤„ç†AIåˆ†æé”™è¯¯
    function handleAIAnalysisError(xhr, status, error) {
        // åœæ­¢è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }

        // æ›´æ–°AIåˆ†æçŠ¶æ€
        $('#ai-analysis-status')
            .text('åˆ†æå¤±è´¥')
            .removeClass('md3-badge-info md3-badge-warning md3-badge-success')
            .addClass('md3-badge-error');

        // æ„å»ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
        let errorMsg = 'åˆ†æè¿‡ç¨‹ä¸­å‡ºé”™';
        let userTip = 'è¯·ç¨åé‡è¯•';

        if (status === 'timeout') {
            errorMsg = 'åˆ†æè¶…æ—¶';
            userTip = 'è¯¥è‚¡ç¥¨åˆ†æéœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·ç¨åé‡è¯•';
        } else if (status === 'not_found') {
            errorMsg = 'åˆ†æä»»åŠ¡ä¸¢å¤±';
            userTip = 'ä»»åŠ¡å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜ä¸¢å¤±ï¼Œè¯·é‡æ–°å¼€å§‹åˆ†æ';
        } else if (status === 'network_error') {
            errorMsg = 'ç½‘ç»œè¿æ¥é—®é¢˜';
            userTip = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
        } else if (status === 'max_retries') {
            errorMsg = 'é‡è¯•æ¬¡æ•°è¿‡å¤š';
            userTip = 'æœåŠ¡å™¨å¯èƒ½ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•';
        } else if (xhr && (xhr.status === 524 || xhr.status === 504)) {
            errorMsg = 'æœåŠ¡å™¨å¤„ç†è¶…æ—¶';
            userTip = 'æœåŠ¡å™¨å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•';
        } else if (xhr && xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
            userTip = 'è¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®';
        } else if (error) {
            errorMsg = error;
        }

        // æ›´æ–°æç¤ºä¿¡æ¯
        $('#ai-analysis-tips').text(userTip);

        // æ˜¾ç¤ºé”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').show();

        // éšè—åŠ è½½åŠ¨ç”»
        $('#ai-analysis-loader').hide();

        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
        console.error('AIåˆ†æé”™è¯¯è¯¦æƒ…:', {
            status: status,
            error: error,
            xhr: xhr,
            errorMsg: errorMsg,
            userTip: userTip
        });
    }
    
    // å–æ¶ˆAIåˆ†æ
    function cancelAnalysis() {
        if (window.currentAnalysisTaskId) {
            $.ajax({
                url: `/api/cancel_analysis/${window.currentAnalysisTaskId}`,
                type: 'POST',
                success: function(response) {
                    // åœæ­¢è®¡æ—¶å™¨
                    if (processingTimer) {
                        clearInterval(processingTimer);
                        processingTimer = null;
                    }
                    
                    // åœæ­¢è½®è¯¢
                    cleanupPollingState();
                    
                    // æ›´æ–°UI
                    $('#ai-analysis-status').text('å·²å–æ¶ˆ').removeClass('bg-info bg-success').addClass('bg-warning');
                    $('#ai-analysis-loader').hide();
                    $('#ai-analysis').html('<div class="alert alert-warning">AIåˆ†æå·²å–æ¶ˆï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡è¯•åˆ†æ"æŒ‰é’®é‡æ–°å¼€å§‹åˆ†æã€‚</div>');
                    $('#ai-analysis-content').css('opacity', '1');
                    $('#error-retry').show();
                },
                error: function(error) {
                    console.error('å–æ¶ˆåˆ†æå¤±è´¥:', error);
                }
            });
        }
    }
    
    // æ¸…ç†è½®è¯¢çŠ¶æ€
    function cleanupPollingState() {
        console.log('æ¸…ç†è½®è¯¢çŠ¶æ€');

        // åœæ­¢è½®è¯¢å®šæ—¶å™¨
        if (window.analysisStatusInterval) {
            clearInterval(window.analysisStatusInterval);
            window.analysisStatusInterval = null;
            console.log('è½®è¯¢å®šæ—¶å™¨å·²æ¸…ç†');
        }

        // åœæ­¢è½®è¯¢è¶…æ—¶å™¨
        if (window.analysisStatusTimeout) {
            clearTimeout(window.analysisStatusTimeout);
            window.analysisStatusTimeout = null;
            console.log('è½®è¯¢è¶…æ—¶å™¨å·²æ¸…ç†');
        }

        // æ¸…ç†è½®è¯¢ç›¸å…³çš„å…¨å±€å˜é‡
        window.currentAnalysisTaskId = null;
        window.pollRetryCount = 0;
        window.pollStartTime = null;
        window.maxPollRetries = null;
        window.maxPollDuration = null;

        console.log('è½®è¯¢çŠ¶æ€å·²æ¸…ç†');
    }

    // é‡ç½®AIåˆ†æUI
    function resetAIAnalysisUI() {
        console.log('é‡ç½®AIåˆ†æUI');

        // æ¸…ç†è½®è¯¢çŠ¶æ€
        cleanupPollingState();

        // åœæ­¢ç°æœ‰è®¡æ—¶å™¨
        if (processingTimer) {
            clearInterval(processingTimer);
            processingTimer = null;
        }

        // é‡ç½®å¤„ç†æ—¶é—´
        processingTime = 0;
        $('#ai-processing-time').text('0');

        // é‡ç½®è¿›åº¦æ¡
        $('#ai-progress-bar').css('width', '0%');

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        $('#ai-analysis-status').text('æ­£åœ¨åˆ†æ...').removeClass('bg-success bg-danger bg-warning').addClass('bg-info');

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œéšè—å†…å®¹
        $('#ai-analysis-loader').show();
        $('#ai-analysis-content').css('opacity', '0');

        // éšè—é”™è¯¯é‡è¯•åŒºåŸŸ
        $('#error-retry').hide();

        console.log('AIåˆ†æUIå·²é‡ç½®');
    }
    
    // æ ¼å¼åŒ–AIåˆ†æ
    function formatAIAnalysis(text) {
    if (!text) return '';

    // å¯¹æ–‡æœ¬è¿›è¡ŒHTMLè½¬ä¹‰ï¼Œç¡®ä¿å®‰å…¨
    const safeText = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    // æ›¿æ¢ Markdown å…ƒç´ 
    let formatted = safeText
        // æ ‡é¢˜ - å¢åŠ å¯¹####å’Œ#####çš„æ”¯æŒ
        .replace(/^# (.*?)$/gm, '<h4 class="mt-3 mb-2">$1</h4>')
        .replace(/^## (.*?)$/gm, '<h5 class="mt-2 mb-2">$1</h5>')
        .replace(/^### (.*?)$/gm, '<h6 class="mt-2 mb-1">$1</h6>')
        .replace(/^#### (.*?)$/gm, '<h6 class="mt-2 mb-1">$1</h6>')
        .replace(/^##### (.*?)$/gm, '<div class="section-header bg-light p-2 rounded mb-2"><strong>$1</strong></div>')
        .replace(/^###### (.*?)$/gm, '<div class="subsection-header p-1 border-bottom mb-2"><strong>$1</strong></div>')
        
        // åŠ ç²—å’Œæ–œä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        
        // é¢œè‰²æ ‡è®°
        .replace(/\[\[ä¸Šæ¶¨\]\]/g, '<span class="trend-up"><i class="fas fa-arrow-up"></i> ä¸Šæ¶¨</span>')
        .replace(/\[\[ä¸‹è·Œ\]\]/g, '<span class="trend-down"><i class="fas fa-arrow-down"></i> ä¸‹è·Œ</span>')
        
        // åº”ç”¨ç‰¹æ®Šæ ·å¼åˆ°é‡‘èæœ¯è¯­
        .replace(/æ”¯æ’‘ä½/g, '<span class="keyword">æ”¯æ’‘ä½</span>')
        .replace(/å‹åŠ›ä½/g, '<span class="keyword">å‹åŠ›ä½</span>')
        .replace(/è¶‹åŠ¿/g, '<span class="keyword">è¶‹åŠ¿</span>')
        .replace(/å‡çº¿/g, '<span class="keyword">å‡çº¿</span>')
        .replace(/MACD/g, '<span class="term">MACD</span>')
        .replace(/RSI/g, '<span class="term">RSI</span>')
        .replace(/KDJ/g, '<span class="term">KDJ</span>')
        
        // çªå‡ºæ˜¾ç¤ºä»·æ ¼æ¨¡å¼å’Œå˜åŠ¨
        .replace(/\b(ä¸Šæ¶¨|å‡|æ¶¨)\b/g, '<span class="trend-up">$1</span>')
        .replace(/\b(ä¸‹è·Œ|é™|è·Œ)\b/g, '<span class="trend-down">$1</span>')
        .replace(/\b(ä¹°å…¥|åšå¤š|å¤šå¤´|çªç ´)\b/g, '<span class="trend-up">$1</span>')
        .replace(/\b(å–å‡º|åšç©º|ç©ºå¤´|è·Œç ´)\b/g, '<span class="trend-down">$1</span>')
        
        // çªå‡ºæ˜¾ç¤ºä»·æ ¼æ•°å€¼ (åŒ¹é…å¦‚ 31.25, 120.50)
        .replace(/(\d+\.\d{2})/g, '<span class="price">$1</span>')
        
        // å°†å¤šä¸ªæ¢è¡Œè½¬æ¢ä¸ºæ®µè½
        .replace(/\n\n+/g, '</p><p class="analysis-para">')
        .replace(/\n/g, '<br>');

    // åŒ…è£…åœ¨æ®µè½æ ‡ç­¾ä¸­ä»¥ä¿æŒä¸€è‡´çš„æ ·å¼
    return '<p class="analysis-para">' + formatted + '</p>';
}
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†é¢œè‰²ç±»
    function getScoreColorClass(score) {
        if (score >= 80) return 'bg-success';
        if (score >= 60) return 'bg-primary';
        if (score >= 40) return 'bg-warning text-dark';
        return 'bg-danger';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†é¢œè‰²
    function getScoreColor(score) {
        if (score >= 80) return '#28a745';
        if (score >= 60) return '#4e73df';
        if (score >= 40) return '#f6c23e';
        return '#e74a3b';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†æ¢¯åº¦é¢œè‰²
    function getScoreGradientColor(score) {
        if (score >= 80) return '#1cc88a';
        if (score >= 60) return '#36b9cc';
        if (score >= 40) return '#f6c23e';
        return '#e74a3b';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å–è¯„åˆ†æè¿°
    function getScoreDescription(score) {
        if (score >= 90) return 'å¼ºçƒˆæ¨è';
        if (score >= 80) return 'æ¨è';
        if (score >= 70) return 'æŒç»­å…³æ³¨';
        if (score >= 60) return 'å…³æ³¨';
        if (score >= 50) return 'è§‚æœ›';
        if (score >= 40) return 'ä¸­æ€§';
        if (score >= 30) return 'å‡æŒ';
        return 'å–å‡º';
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    function showError(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#alerts-container').html(alertHtml);
    }

    // è¯„åˆ†æ˜ç»†å±•å¼€/æ”¶èµ·åŠŸèƒ½
    let scoreDetailsExpanded = false;

    function toggleScoreDetails() {
        const container = $('#score-details-container');
        const icon = $('#score-details-icon');
        const text = $('#score-details-text');

        if (scoreDetailsExpanded) {
            // æ”¶èµ·
            container.removeClass('expanded');
            icon.text('expand_more');
            text.text('æŸ¥çœ‹è¯„åˆ†æ˜ç»†');
            scoreDetailsExpanded = false;
        } else {
            // å±•å¼€
            container.addClass('expanded');
            icon.text('expand_less');
            text.text('æ”¶èµ·è¯„åˆ†æ˜ç»†');
            scoreDetailsExpanded = true;
        }
    }

    // æ¸²æŸ“è¯„åˆ†æ˜ç»†
    function renderScoreDetails(scoreDetails, totalScore, scoreBreakdown = {}) {
        if (!scoreDetails || Object.keys(scoreDetails).length === 0) {
            return;
        }

        // è¯„åˆ†ç»´åº¦é…ç½®
        const dimensionConfig = {
            trend: {
                name: 'è¶‹åŠ¿åˆ†æ',
                description: 'åŸºäºç§»åŠ¨å¹³å‡çº¿å’Œä»·æ ¼è¶‹åŠ¿çš„æŠ€æœ¯åˆ†æ',
                weight: 30,
                maxScore: 30,
                icon: 'trending_up'
            },
            technical: {
                name: 'æŠ€æœ¯æŒ‡æ ‡',
                description: 'åŒ…æ‹¬RSIã€MACDã€å¸ƒæ—å¸¦ç­‰æŠ€æœ¯æŒ‡æ ‡ç»¼åˆè¯„ä¼°',
                weight: 25,
                maxScore: 25,
                icon: 'show_chart'
            },
            volume: {
                name: 'æˆäº¤é‡åˆ†æ',
                description: 'åŸºäºæˆäº¤é‡å˜åŒ–å’Œèµ„é‡‘æµå‘çš„åˆ†æ',
                weight: 20,
                maxScore: 20,
                icon: 'bar_chart'
            },
            volatility: {
                name: 'æ³¢åŠ¨ç‡è¯„ä¼°',
                description: 'è‚¡ä»·æ³¢åŠ¨ç‡å’Œé£é™©è¯„ä¼°æŒ‡æ ‡',
                weight: 15,
                maxScore: 15,
                icon: 'timeline'
            },
            momentum: {
                name: 'åŠ¨é‡æŒ‡æ ‡',
                description: 'ä»·æ ¼åŠ¨é‡å’Œå˜åŒ–ç‡åˆ†æ',
                weight: 10,
                maxScore: 10,
                icon: 'speed'
            }
        };

        let detailsHtml = `
            <div class="score-details-summary">
                <h4>
                    <i class="material-icons">info</i>
                    è¯„åˆ†è®¡ç®—è¯´æ˜
                </h4>
                <p>ç»¼åˆè¯„åˆ†åŸºäºäº”ä¸ªæ ¸å¿ƒç»´åº¦çš„åŠ æƒè®¡ç®—ï¼Œæ€»åˆ†100åˆ†ã€‚å„ç»´åº¦æƒé‡å’Œè¯„åˆ†æ ‡å‡†å¦‚ä¸‹ï¼š</p>
            </div>
        `;

        // æ¸²æŸ“å„ä¸ªç»´åº¦
        Object.keys(dimensionConfig).forEach(key => {
            const config = dimensionConfig[key];
            const score = scoreDetails[key] || 0;
            const percentage = (score / config.maxScore) * 100;
            const breakdown = scoreBreakdown[key] || {};
            const hasDetailedInfo = breakdown.indicators && breakdown.logic;

            detailsHtml += `
                <div class="score-details-item">
                    <div class="score-dimension">
                        <div class="score-dimension-header">
                            <div class="score-dimension-name">
                                <i class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--md-sys-color-primary);">${config.icon}</i>
                                ${config.name}
                                <span class="score-weight-display">(æƒé‡: ${config.weight}%)</span>
                            </div>
                            ${hasDetailedInfo ? `
                                <button class="score-detail-toggle md3-icon-button"
                                        onclick="toggleScoreDetail('${key}')"
                                        aria-label="æŸ¥çœ‹${config.name}è¯¦æƒ…">
                                    <i class="material-icons">info</i>
                                </button>
                            ` : ''}
                        </div>
                        <div class="score-dimension-desc">${config.description}</div>
                    </div>
                    <div class="score-progress-container">
                        <div class="score-progress-bar">
                            <div class="score-progress-fill" style="width: ${percentage}%;"></div>
                        </div>
                        <div class="score-value-display">${score}/${config.maxScore}</div>
                    </div>
                    ${hasDetailedInfo ? `
                        <div class="score-detail-panel" id="detail-${key}" style="display: none;">
                            <div class="score-detail-content">
                                <h5 class="score-detail-title">
                                    <i class="material-icons">analytics</i>
                                    è¯„åˆ†ä¾æ®è¯¦æƒ…
                                </h5>

                                <div class="score-indicators-section">
                                    <h6>å…³é”®æŒ‡æ ‡æ•°å€¼</h6>
                                    <div class="indicators-grid">
                                        ${Object.entries(breakdown.indicators || {}).map(([indicator, value]) => `
                                            <div class="indicator-item">
                                                <span class="indicator-name">${indicator}:</span>
                                                <span class="indicator-value">${typeof value === 'number' ? value.toFixed(2) : value}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="score-logic-section">
                                    <h6>è¯„åˆ†é€»è¾‘</h6>
                                    <div class="logic-list">
                                        ${(breakdown.logic || []).map(logic => `
                                            <div class="logic-item">${logic}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        // æ·»åŠ æ€»åˆ†è¯´æ˜
        detailsHtml += `
            <div class="score-details-item" style="border-top: 2px solid var(--md-sys-color-primary); margin-top: 16px; padding-top: 16px;">
                <div class="score-dimension">
                    <div class="score-dimension-name">
                        <i class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--md-sys-color-primary);">analytics</i>
                        ç»¼åˆè¯„åˆ†
                    </div>
                    <div class="score-dimension-desc">åŸºäºå„ç»´åº¦åŠ æƒè®¡ç®—çš„æœ€ç»ˆæŠ•èµ„è¯„åˆ†</div>
                </div>
                <div class="score-progress-container">
                    <div class="score-progress-bar">
                        <div class="score-progress-fill" style="width: ${totalScore}%; background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary));"></div>
                    </div>
                    <div class="score-value-display" style="font-size: 18px; font-weight: bold;">${totalScore}/100</div>
                </div>
            </div>
        `;

        $('#score-details-container').html(detailsHtml);
    }

    // åˆ‡æ¢è¯„åˆ†è¯¦æƒ…é¢æ¿æ˜¾ç¤º
    function toggleScoreDetail(dimensionKey) {
        const panel = $(`#detail-${dimensionKey}`);
        const button = panel.siblings('.score-dimension').find('.score-detail-toggle i');

        if (panel.is(':visible')) {
            panel.slideUp(300);
            button.text('info');
        } else {
            // å…ˆå…³é—­å…¶ä»–å·²æ‰“å¼€çš„é¢æ¿
            $('.score-detail-panel:visible').slideUp(300);
            $('.score-detail-toggle i').text('info');

            // æ‰“å¼€å½“å‰é¢æ¿
            panel.slideDown(300);
            button.text('info_outline');
        }
    }

    // æ˜¾ç¤ºä¿¡æ¯æç¤º
    function showInfo(message) {
        const alertHtml = `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#alerts-container').html(alertHtml);
    }
</script>
{% endblock %}