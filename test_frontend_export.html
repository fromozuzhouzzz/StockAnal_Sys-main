<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端导出功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 前端导出功能测试</h1>
        
        <div class="test-section">
            <h3>📊 测试数据</h3>
            <p>当前测试投资组合包含以下股票：</p>
            <ul id="portfolio-list">
                <li>000001.SZ - 平安银行 (30%)</li>
                <li>000002.SZ - 万科A (25%)</li>
                <li>600000.SH - 浦发银行 (45%)</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>🚀 导出功能测试</h3>
            <button onclick="testClientSideExport()">测试前端直接导出</button>
            <button onclick="testApiExport()">测试API导出</button>
            <button onclick="testSimpleApiExport()">测试简化API导出</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <div class="test-section">
            <h3>📝 测试日志</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // 模拟投资组合数据
        const portfolio = [
            {
                stock_code: '000001.SZ',
                stock_name: '平安银行',
                industry: '银行',
                price: 12.50,
                price_change: 0.15,
                price_change_percent: 1.20,
                weight: 30,
                score: 78.5,
                recommendation: '买入'
            },
            {
                stock_code: '000002.SZ',
                stock_name: '万科A',
                industry: '房地产',
                price: 18.30,
                price_change: -0.25,
                price_change_percent: -1.35,
                weight: 25,
                score: 65.2,
                recommendation: '持有'
            },
            {
                stock_code: '600000.SH',
                stock_name: '浦发银行',
                industry: '银行',
                price: 8.90,
                price_change: 0.08,
                price_change_percent: 0.91,
                weight: 45,
                score: 72.8,
                recommendation: '买入'
            }
        ];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // 前端直接导出功能（复制自修复后的代码）
        function testClientSideExport() {
            log('开始测试前端直接导出功能...', 'info');
            
            try {
                // 生成CSV内容
                let csvContent = '\ufeff'; // UTF-8 BOM
                
                // 添加投资组合概览信息
                const timestamp = new Date().toLocaleString('zh-CN');
                csvContent += `投资组合名称,测试投资组合\n`;
                csvContent += `导出时间,${timestamp}\n`;
                csvContent += `股票数量,${portfolio.length}\n`;
                csvContent += `导出方式,前端直接导出\n`;
                csvContent += '\n'; // 空行分隔
                
                // 添加表头
                csvContent += '股票代码,股票名称,所属行业,当前价格,价格变化,价格变化百分比,投资组合权重,综合评分,投资建议,分析时间\n';
                
                // 计算统计数据
                let totalWeight = 0;
                let totalScore = 0;
                let validScores = 0;
                
                // 添加股票数据
                portfolio.forEach(stock => {
                    const escapeCsvField = (field) => {
                        if (typeof field === 'string' && (field.includes(',') || field.includes('"') || field.includes('\n'))) {
                            return `"${field.replace(/"/g, '""')}"`;
                        }
                        return field;
                    };
                    
                    csvContent += `${escapeCsvField(stock.stock_code)},`;
                    csvContent += `${escapeCsvField(stock.stock_name)},`;
                    csvContent += `${escapeCsvField(stock.industry)},`;
                    csvContent += `${stock.price.toFixed(2)},`;
                    csvContent += `${stock.price_change.toFixed(2)},`;
                    csvContent += `${stock.price_change_percent.toFixed(2)}%,`;
                    csvContent += `${stock.weight.toFixed(1)}%,`;
                    csvContent += `${stock.score.toFixed(2)},`;
                    csvContent += `${escapeCsvField(stock.recommendation)},`;
                    csvContent += `${timestamp}\n`;
                    
                    totalWeight += stock.weight;
                    if (stock.score > 0) {
                        totalScore += stock.score * stock.weight;
                        validScores += stock.weight;
                    }
                });
                
                // 添加统计信息
                csvContent += '\n';
                csvContent += '统计信息\n';
                csvContent += `总权重,${totalWeight.toFixed(1)}%\n`;
                if (validScores > 0) {
                    const avgScore = totalScore / validScores;
                    csvContent += `加权平均评分,${avgScore.toFixed(2)}\n`;
                }
                
                // 创建并下载文件
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8-sig' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const now = new Date();
                const dateStr = now.getFullYear() + 
                               String(now.getMonth() + 1).padStart(2, '0') + 
                               String(now.getDate()).padStart(2, '0') + '_' +
                               String(now.getHours()).padStart(2, '0') + 
                               String(now.getMinutes()).padStart(2, '0') + 
                               String(now.getSeconds()).padStart(2, '0');
                const filename = `测试投资组合_前端导出_${dateStr}.csv`;
                
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                log(`✅ 前端直接导出成功！文件名: ${filename}`, 'success');
                log(`📊 导出数据: ${portfolio.length}只股票, 总权重: ${totalWeight}%`, 'info');
                
            } catch (error) {
                log(`❌ 前端导出失败: ${error.message}`, 'error');
                console.error('前端导出错误:', error);
            }
        }

        function testApiExport() {
            log('开始测试API导出功能...', 'info');
            
            const data = {
                stocks: portfolio.map(stock => ({
                    stock_code: stock.stock_code,
                    weight: stock.weight,
                    market_type: 'A'
                })),
                portfolio_name: '测试投资组合',
                export_format: 'csv'
            };

            $.ajax({
                url: 'https://fromozu-stock-analysis.hf.space/api/v1/portfolio/export',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'UZXJfw3YNX80DLfN'
                },
                data: JSON.stringify(data),
                xhrFields: { responseType: 'blob' },
                success: function(data, status, xhr) {
                    log('✅ API导出成功！', 'success');
                    
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = '测试导出.csv';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) filename = match[1];
                    }
                    
                    const blob = new Blob([data], { type: 'text/csv;charset=utf-8-sig' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log(`📁 文件已下载: ${filename}`, 'info');
                },
                error: function(xhr, status, error) {
                    log(`❌ API导出失败: ${xhr.status} ${xhr.statusText}`, 'error');
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        log(`错误详情: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    } catch (e) {
                        log(`响应内容: ${xhr.responseText}`, 'error');
                    }
                }
            });
        }

        function testSimpleApiExport() {
            log('开始测试简化API导出功能...', 'info');
            
            const data = {
                stocks: portfolio.map(stock => ({
                    stock_code: stock.stock_code,
                    weight: stock.weight,
                    market_type: 'A'
                })),
                portfolio_name: '测试投资组合'
            };

            $.ajax({
                url: 'https://fromozu-stock-analysis.hf.space/api/portfolio/export-simple',
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                data: JSON.stringify(data),
                xhrFields: { responseType: 'blob' },
                success: function(data, status, xhr) {
                    log('✅ 简化API导出成功！', 'success');
                    
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = '测试简化导出.csv';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) filename = match[1];
                    }
                    
                    const blob = new Blob([data], { type: 'text/csv;charset=utf-8-sig' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log(`📁 文件已下载: ${filename}`, 'info');
                },
                error: function(xhr, status, error) {
                    log(`❌ 简化API导出失败: ${xhr.status} ${xhr.statusText}`, 'error');
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        log(`错误详情: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    } catch (e) {
                        log(`响应内容: ${xhr.responseText}`, 'error');
                    }
                }
            });
        }

        // 页面加载完成后的初始化
        $(document).ready(function() {
            log('🧪 前端导出功能测试页面已加载', 'info');
            log('📋 测试数据已准备就绪，包含3只测试股票', 'info');
            log('🎯 请点击上方按钮开始测试各种导出功能', 'info');
        });
    </script>
</body>
</html>
