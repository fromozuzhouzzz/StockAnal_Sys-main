<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å‰ç«¯å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•æ•°æ®</h3>
            <p>å½“å‰æµ‹è¯•æŠ•èµ„ç»„åˆåŒ…å«ä»¥ä¸‹è‚¡ç¥¨ï¼š</p>
            <ul id="portfolio-list">
                <li>000001.SZ - å¹³å®‰é“¶è¡Œ (30%)</li>
                <li>000002.SZ - ä¸‡ç§‘A (25%)</li>
                <li>600000.SH - æµ¦å‘é“¶è¡Œ (45%)</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ å¯¼å‡ºåŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testClientSideExport()">æµ‹è¯•å‰ç«¯ç›´æ¥å¯¼å‡º</button>
            <button onclick="testApiExport()">æµ‹è¯•APIå¯¼å‡º</button>
            <button onclick="testSimpleApiExport()">æµ‹è¯•ç®€åŒ–APIå¯¼å‡º</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // æ¨¡æ‹ŸæŠ•èµ„ç»„åˆæ•°æ®
        const portfolio = [
            {
                stock_code: '000001.SZ',
                stock_name: 'å¹³å®‰é“¶è¡Œ',
                industry: 'é“¶è¡Œ',
                price: 12.50,
                price_change: 0.15,
                price_change_percent: 1.20,
                weight: 30,
                score: 78.5,
                recommendation: 'ä¹°å…¥'
            },
            {
                stock_code: '000002.SZ',
                stock_name: 'ä¸‡ç§‘A',
                industry: 'æˆ¿åœ°äº§',
                price: 18.30,
                price_change: -0.25,
                price_change_percent: -1.35,
                weight: 25,
                score: 65.2,
                recommendation: 'æŒæœ‰'
            },
            {
                stock_code: '600000.SH',
                stock_name: 'æµ¦å‘é“¶è¡Œ',
                industry: 'é“¶è¡Œ',
                price: 8.90,
                price_change: 0.08,
                price_change_percent: 0.91,
                weight: 45,
                score: 72.8,
                recommendation: 'ä¹°å…¥'
            }
        ];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // å‰ç«¯ç›´æ¥å¯¼å‡ºåŠŸèƒ½ï¼ˆå¤åˆ¶è‡ªä¿®å¤åçš„ä»£ç ï¼‰
        function testClientSideExport() {
            log('å¼€å§‹æµ‹è¯•å‰ç«¯ç›´æ¥å¯¼å‡ºåŠŸèƒ½...', 'info');
            
            try {
                // ç”ŸæˆCSVå†…å®¹
                let csvContent = '\ufeff'; // UTF-8 BOM
                
                // æ·»åŠ æŠ•èµ„ç»„åˆæ¦‚è§ˆä¿¡æ¯
                const timestamp = new Date().toLocaleString('zh-CN');
                csvContent += `æŠ•èµ„ç»„åˆåç§°,æµ‹è¯•æŠ•èµ„ç»„åˆ\n`;
                csvContent += `å¯¼å‡ºæ—¶é—´,${timestamp}\n`;
                csvContent += `è‚¡ç¥¨æ•°é‡,${portfolio.length}\n`;
                csvContent += `å¯¼å‡ºæ–¹å¼,å‰ç«¯ç›´æ¥å¯¼å‡º\n`;
                csvContent += '\n'; // ç©ºè¡Œåˆ†éš”
                
                // æ·»åŠ è¡¨å¤´
                csvContent += 'è‚¡ç¥¨ä»£ç ,è‚¡ç¥¨åç§°,æ‰€å±è¡Œä¸š,å½“å‰ä»·æ ¼,ä»·æ ¼å˜åŒ–,ä»·æ ¼å˜åŒ–ç™¾åˆ†æ¯”,æŠ•èµ„ç»„åˆæƒé‡,ç»¼åˆè¯„åˆ†,æŠ•èµ„å»ºè®®,åˆ†ææ—¶é—´\n';
                
                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                let totalWeight = 0;
                let totalScore = 0;
                let validScores = 0;
                
                // æ·»åŠ è‚¡ç¥¨æ•°æ®
                portfolio.forEach(stock => {
                    const escapeCsvField = (field) => {
                        if (typeof field === 'string' && (field.includes(',') || field.includes('"') || field.includes('\n'))) {
                            return `"${field.replace(/"/g, '""')}"`;
                        }
                        return field;
                    };
                    
                    csvContent += `${escapeCsvField(stock.stock_code)},`;
                    csvContent += `${escapeCsvField(stock.stock_name)},`;
                    csvContent += `${escapeCsvField(stock.industry)},`;
                    csvContent += `${stock.price.toFixed(2)},`;
                    csvContent += `${stock.price_change.toFixed(2)},`;
                    csvContent += `${stock.price_change_percent.toFixed(2)}%,`;
                    csvContent += `${stock.weight.toFixed(1)}%,`;
                    csvContent += `${stock.score.toFixed(2)},`;
                    csvContent += `${escapeCsvField(stock.recommendation)},`;
                    csvContent += `${timestamp}\n`;
                    
                    totalWeight += stock.weight;
                    if (stock.score > 0) {
                        totalScore += stock.score * stock.weight;
                        validScores += stock.weight;
                    }
                });
                
                // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                csvContent += '\n';
                csvContent += 'ç»Ÿè®¡ä¿¡æ¯\n';
                csvContent += `æ€»æƒé‡,${totalWeight.toFixed(1)}%\n`;
                if (validScores > 0) {
                    const avgScore = totalScore / validScores;
                    csvContent += `åŠ æƒå¹³å‡è¯„åˆ†,${avgScore.toFixed(2)}\n`;
                }
                
                // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8-sig' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                const now = new Date();
                const dateStr = now.getFullYear() + 
                               String(now.getMonth() + 1).padStart(2, '0') + 
                               String(now.getDate()).padStart(2, '0') + '_' +
                               String(now.getHours()).padStart(2, '0') + 
                               String(now.getMinutes()).padStart(2, '0') + 
                               String(now.getSeconds()).padStart(2, '0');
                const filename = `æµ‹è¯•æŠ•èµ„ç»„åˆ_å‰ç«¯å¯¼å‡º_${dateStr}.csv`;
                
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                log(`âœ… å‰ç«¯ç›´æ¥å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å: ${filename}`, 'success');
                log(`ğŸ“Š å¯¼å‡ºæ•°æ®: ${portfolio.length}åªè‚¡ç¥¨, æ€»æƒé‡: ${totalWeight}%`, 'info');
                
            } catch (error) {
                log(`âŒ å‰ç«¯å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
                console.error('å‰ç«¯å¯¼å‡ºé”™è¯¯:', error);
            }
        }

        function testApiExport() {
            log('å¼€å§‹æµ‹è¯•APIå¯¼å‡ºåŠŸèƒ½...', 'info');
            
            const data = {
                stocks: portfolio.map(stock => ({
                    stock_code: stock.stock_code,
                    weight: stock.weight,
                    market_type: 'A'
                })),
                portfolio_name: 'æµ‹è¯•æŠ•èµ„ç»„åˆ',
                export_format: 'csv'
            };

            $.ajax({
                url: 'https://fromozu-stock-analysis.hf.space/api/v1/portfolio/export',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'UZXJfw3YNX80DLfN'
                },
                data: JSON.stringify(data),
                xhrFields: { responseType: 'blob' },
                success: function(data, status, xhr) {
                    log('âœ… APIå¯¼å‡ºæˆåŠŸï¼', 'success');
                    
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = 'æµ‹è¯•å¯¼å‡º.csv';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) filename = match[1];
                    }
                    
                    const blob = new Blob([data], { type: 'text/csv;charset=utf-8-sig' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log(`ğŸ“ æ–‡ä»¶å·²ä¸‹è½½: ${filename}`, 'info');
                },
                error: function(xhr, status, error) {
                    log(`âŒ APIå¯¼å‡ºå¤±è´¥: ${xhr.status} ${xhr.statusText}`, 'error');
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    } catch (e) {
                        log(`å“åº”å†…å®¹: ${xhr.responseText}`, 'error');
                    }
                }
            });
        }

        function testSimpleApiExport() {
            log('å¼€å§‹æµ‹è¯•ç®€åŒ–APIå¯¼å‡ºåŠŸèƒ½...', 'info');
            
            const data = {
                stocks: portfolio.map(stock => ({
                    stock_code: stock.stock_code,
                    weight: stock.weight,
                    market_type: 'A'
                })),
                portfolio_name: 'æµ‹è¯•æŠ•èµ„ç»„åˆ'
            };

            $.ajax({
                url: 'https://fromozu-stock-analysis.hf.space/api/portfolio/export-simple',
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                data: JSON.stringify(data),
                xhrFields: { responseType: 'blob' },
                success: function(data, status, xhr) {
                    log('âœ… ç®€åŒ–APIå¯¼å‡ºæˆåŠŸï¼', 'success');
                    
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = 'æµ‹è¯•ç®€åŒ–å¯¼å‡º.csv';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename="(.+)"/);
                        if (match) filename = match[1];
                    }
                    
                    const blob = new Blob([data], { type: 'text/csv;charset=utf-8-sig' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    log(`ğŸ“ æ–‡ä»¶å·²ä¸‹è½½: ${filename}`, 'info');
                },
                error: function(xhr, status, error) {
                    log(`âŒ ç®€åŒ–APIå¯¼å‡ºå¤±è´¥: ${xhr.status} ${xhr.statusText}`, 'error');
                    try {
                        const errorData = JSON.parse(xhr.responseText);
                        log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    } catch (e) {
                        log(`å“åº”å†…å®¹: ${xhr.responseText}`, 'error');
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        $(document).ready(function() {
            log('ğŸ§ª å‰ç«¯å¯¼å‡ºåŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ğŸ“‹ æµ‹è¯•æ•°æ®å·²å‡†å¤‡å°±ç»ªï¼ŒåŒ…å«3åªæµ‹è¯•è‚¡ç¥¨', 'info');
            log('ğŸ¯ è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„ç§å¯¼å‡ºåŠŸèƒ½', 'info');
        });
    </script>
</body>
</html>
